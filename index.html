<!DOCTYPE html>
<html lang="ja" class="notranslate">
<head>
    <meta charset="UTF-8">
    <title>営業管理システム</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Hiragino Sans', sans-serif; background-color: #f0f4f8; padding: 0; margin: 0; color: #333; }
        #pw_screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a202c; display: flex; justify-content: center; align-items: center; z-index: 10000; }
        #pw_box { background: white; padding: 80px 60px; border-radius: 16px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.5); transform: scale(1.2); }
        #pass_val { padding: 15px; width: 280px; font-size: 1.2rem; text-align: center; border: 2px solid #cbd5e0; border-radius: 8px; }
        #pw_box h2 { font-size: 2rem; margin-bottom: 30px; }
        #pw_box button { padding: 15px 50px; font-size: 1.2rem; border-radius: 8px; }

        #main_content { display: none; }
        .nav-bar { background: #2d3748; display: flex; align-items: center; position: sticky; top: 0; z-index: 1000; height: 60px; }
        .nav-item { padding: 0 25px; height: 60px; line-height: 60px; color: #a0aec0; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; }
        .nav-item.active { color: white; border-bottom: 3px solid #3182ce; background: rgba(255,255,255,0.05); }
        #sync_status { font-size: 12px; color: #cbd5e0; margin-left: auto; padding-right: 20px; }
        .container { padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow-x: auto; margin-bottom: 25px; }
        
        /* 共通テーブル設定 */
        table { border-collapse: collapse; background: white; border: 4px solid black !important; font-size: 1.1rem; width: 100%; }
        th, td { border: 4px solid black; padding: 12px 6px; overflow: hidden; box-sizing: border-box; }
        th { background: #edf2f7; font-weight: bold; }
        .text-right { text-align: right !important; padding-right: 12px !important; }
        .text-center { text-align: center !important; }

        /* 実績表の特殊枠線 (一切触れていません) */
        .perf-table { min-width: 1800px; table-layout: fixed; }
        tr.bb-2px td:not(.cat-header) { border-bottom: 2px solid black !important; }
        tr.bt-2px td:not(.cat-header) { border-top: 2px solid black !important; }
        tr.bb-3px td:not(.cat-header) { border-bottom: 3px solid black !important; }
        tr.bt-3px td:not(.cat-header) { border-top: 3px solid black !important; }
        tr.bb-4px td { border-bottom: 4px solid black !important; }
        .br-3px { border-right: 3px solid black !important; }
        .bl-3px { border-left: 3px solid black !important; }
        .col-item { width: 220px; }
        .col-type { width: 120px; }
        .col-total { width: 160px; background: #fffaf0 !important; font-weight: bold; }
        .cat-header { background: #ebf8ff !important; font-weight: bold; text-align: center; }
        .sticky-left { position: sticky; left: 0; z-index: 30; background: #ebf8ff !important; border-right: 4px solid black !important; }
        .sticky-left-2 { position: sticky; left: 220px; z-index: 30; background: white !important; border-left: 4px solid black !important; border-right: 4px solid black !important; }

        /* 営業推進管理表 (1画面に収まるよう幅を縮小・最適化) */
        .sales-raw-table { width: 100%; min-width: 1450px; table-layout: fixed; font-size: 0.9rem; }
        .sales-raw-table th, .sales-raw-table td { padding: 8px 4px; }
        .col-sales-aff { width: 70px !important; }
        .col-sales-name { width: 130px !important; }
        .col-sales-info { width: 80px !important; }

        /* 売込状況一覧 (一切触れていません) */
        .status-table { min-width: 1400px; table-layout: fixed; font-size: 1.25rem; }
        .status-table th, .status-table td { padding: 18px 12px; }
        .col-status-aff { width: 160px; }
        .col-status-name { width: 220px; }
        .col-status-salary { width: 140px; } 
        .col-status-cond { width: 160px; }
        .col-status-reason { width: 360px; }
        .col-status-date { width: 200px; }
        .col-status-period { width: 160px; }
        
        .status-wait { color: #c53030 !important; font-weight: bold; background-color: #fff5f5 !important; }
        .status-active { color: #2b6cb0 !important; font-weight: bold; background-color: #ffffe0 !important; }

        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; height: 400px; }

        @media (max-width: 768px) {
            .nav-bar { flex-wrap: wrap; height: auto; }
            .nav-item { padding: 12px 5px; flex: 1; text-align: center; font-size: 0.85rem; height: auto; line-height: 1.2; }
            .container { padding: 10px; }
            .card > div:first-child { flex-direction: column; align-items: flex-start !important; }
            select, input[type="text"] { width: 100% !important; margin: 10px 0 !important; }
            .sticky-left, .sticky-left-2 { position: static !important; }
            .charts-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div id="pw_screen"><div id="pw_box">
    <h2 style="margin:0 0 30px 0;">営業管理システム</h2>
    <input type="password" id="pass_val" onkeydown="if(event.keyCode==13)checkPW()"><br><br>
    <button onclick="checkPW()" style="background:#3182ce; color:white; border:none; cursor:pointer; font-weight:bold;">ログイン</button>
    <p id="err_msg" style="color:red; display:none; font-size:1.2rem; margin-top:20px;">パスワードが違います</p>
</div></div>

<div id="main_content">
    <div class="nav-bar">
        <div class="nav-item active" id="tab-perf" onclick="switchTab('perf')">実績管理</div>
        <div class="nav-item" id="tab-sales" onclick="switchTab('sales')">営業推進管理表</div>
        <div class="nav-item" id="tab-status" onclick="switchTab('status')">売込状況一覧</div>
        <div id="sync_status">データ同期中...</div>
    </div>

    <div class="container">
        <div id="section-perf">
            <div class="card">
                <div style="font-size: 1.6rem; font-weight: bold; color: #1a202c; margin-bottom: 15px;">2025年6月期</div>
                <div style="display:flex; align-items:center; margin-bottom:20px;">
                    <h2 style="margin:0; border-left:5px solid #3182ce; padding-left:15px; margin-right: 25px;">拠点別実績・予算</h2>
                    <select id="region-select" style="padding:10px 20px; border-radius:6px; font-size:1.1rem; cursor:pointer;" onchange="renderPerf()">
                        <option value="全国">全国</option><option value="東海">東海</option><option value="首都圏">首都圏</option><option value="東日本">東日本</option><option value="西日本">西日本</option>
                    </select>
                </div>
                <div style="overflow-x: auto;">
                    <table class="perf-table">
                        <thead>
                            <tr>
                                <th rowspan="2" class="col-item sticky-left">項目</th><th rowspan="2" class="col-type sticky-left-2">区分</th>
                                <th colspan="6">上期実績</th><th class="col-total">上期計</th>
                                <th colspan="6">下期実績</th><th class="col-total">下期計</th>
                                <th class="col-total">年間計</th>
                            </tr>
                            <tr>
                                <th class="br-3px text-center">6月</th><th class="bl-3px br-3px text-center">7月</th><th class="bl-3px br-3px text-center">8月</th><th class="bl-3px br-3px text-center">9月</th><th class="bl-3px br-3px text-center">10月</th><th class="bl-3px text-center">11月</th><th class="col-total text-center">計</th>
                                <th class="br-3px text-center">12月</th><th class="bl-3px br-3px text-center">1月</th><th class="bl-3px br-3px text-center">2月</th><th class="bl-3px br-3px text-center">3月</th><th class="bl-3px br-3px text-center">4月</th><th class="bl-3px text-center">5月</th><th class="col-total text-center">計</th>
                                <th class="col-total text-center">合計</th>
                            </tr>
                        </thead>
                        <tbody id="perf-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="charts-container">
                <div class="chart-box"><canvas id="salesChart"></canvas></div>
                <div class="chart-box"><canvas id="engChart"></canvas></div>
                <div class="chart-box"><canvas id="waitCostChart"></canvas></div>
            </div>
        </div>

        <div id="section-sales" style="display:none;">
            <div class="card">
                <div style="display:flex; align-items:center; margin-bottom:20px;">
                    <h2 style="margin:0; border-left:5px solid #48bb78; padding-left:15px; margin-right: 25px;">営業推進管理表</h2>
                    <select id="sales-region-select" style="padding:10px 20px; border-radius:6px; font-size:1.1rem; cursor:pointer;" onchange="renderSales()">
                        <option value="全国">全国</option><option value="東海">東海</option><option value="首都圏">首都圏</option><option value="東日本">東日本</option><option value="西日本">西日本</option>
                    </select>
                    <input type="text" id="sales-search" placeholder="技術者名検索..." style="padding:10px; width:300px; border-radius:6px; border:1px solid #cbd5e0; margin-left:auto;" oninput="renderSales()">
                </div>
                <div style="overflow-x: auto;">
                    <table class="sales-raw-table"><thead id="sales-head"></thead><tbody id="sales-body"></tbody></table>
                </div>
            </div>
        </div>

        <div id="section-status" style="display:none;">
            <div class="card">
                <div style="display:flex; align-items:center; margin-bottom:25px;">
                    <h2 style="margin:0; border-left:6px solid #ed8936; padding-left:20px; margin-right: 30px; font-size:1.6rem;">売込状況一覧</h2>
                    <select id="status-region-select" style="padding:12px 25px; border-radius:8px; font-size:1.2rem; cursor:pointer; border: 2px solid #ed8936;" onchange="renderStatus()">
                        <option value="全国">全国</option><option value="東海">東海</option><option value="首都圏">首都圏</option><option value="東日本">東日本</option><option value="西日本">西日本</option>
                    </select>
                    <span id="status-update-date" style="margin-left: 30px; font-size: 1.2rem; font-weight: bold; color: #4a5568;"></span>
                </div>
                <div style="overflow-x: auto;">
                    <table class="status-table">
                        <thead>
                            <tr>
                                <th class="col-status-aff">所属</th><th class="col-status-name">従業員名</th><th class="col-status-salary">給料</th><th class="col-status-cond">稼働状況</th><th class="col-status-reason">退場理由</th><th class="col-status-date">参画可能日</th><th class="col-status-period">未参画期間</th>
                            </tr>
                        </thead>
                        <tbody id="status-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzLPhdnyAo1D7SH-T3uv0EOb5aWekcfnFRtReGhsnkQ5_sLbi36fTc6o5eVYukeliVJIA/exec';
    let perfMap = {}, salesRows = [], statusRows = [], charts = {};

    window.onload = () => {
        const cP = localStorage.getItem('f_perf'), cS = localStorage.getItem('f_sales'), cSt = localStorage.getItem('f_status');
        if(cP) perfMap = JSON.parse(cP); if(cS) salesRows = JSON.parse(cS); if(cSt) statusRows = JSON.parse(cSt);
        fetchAll();
    };

    function checkPW() {
        if (document.getElementById('pass_val').value === "freeeks2022") {
            document.getElementById('pw_screen').style.display = 'none';
            document.getElementById('main_content').style.display = 'block';
            renderAll();
        } else { document.getElementById('err_msg').style.display = 'block'; }
    }

    function switchTab(tab) {
        ['perf', 'sales', 'status'].forEach(t => {
            document.getElementById(`section-${t}`).style.display = (t === tab) ? 'block' : 'none';
            document.getElementById(`tab-${t}`).className = 'nav-item' + (t === tab ? ' active' : '');
        });
        renderAll();
    }

    async function fetchAll() {
        try {
            const [rP, rS] = await Promise.all([
                fetch(`${GAS_URL}?p=freeeks2022&s=実績データ`),
                fetch(`${GAS_URL}?p=freeeks2022&s=営業推進管理表`)
            ]);
            let rSt = await fetch(`${GAS_URL}?p=freeeks2022&s=売込状況一覧`);
            let stData = await rSt.json();
            if (!stData || stData.length <= 1 || stData.error) {
                const rStFallback = await fetch(`${GAS_URL}?p=freeeks2022&s=売込状況`);
                stData = await rStFallback.json();
            }
            const rowsP = await rP.json(); perfMap = {};
            if (rowsP && Array.isArray(rowsP)) {
                rowsP.slice(1).forEach(r => { perfMap[`${r[0]}-${r[1]}-${r[2]}`] = r.slice(3, 15).map(v => (v===""||v==null)?null:parseFloat(String(v).replace(/,/g,''))||0); });
            }
            salesRows = await rS.json();
            statusRows = stData;
            localStorage.setItem('f_perf', JSON.stringify(perfMap)); 
            localStorage.setItem('f_sales', JSON.stringify(salesRows));
            localStorage.setItem('f_status', JSON.stringify(statusRows));
            document.getElementById('sync_status').innerText = '最新データ同期完了'; 
            renderAll();
        } catch (e) { document.getElementById('sync_status').innerText = '同期失敗'; }
    }

    function renderAll() {
        try { if (document.getElementById('section-perf').style.display !== 'none') renderPerf(); } catch(e){}
        try { if (document.getElementById('section-sales').style.display !== 'none') renderSales(); } catch(e){}
        try { if (document.getElementById('section-status').style.display !== 'none') renderStatus(); } catch(e){}
    }

    /* ----------------------------------------------------
       共通：数値変換
    ---------------------------------------------------- */
    const parseNum = (v) => {
        if (typeof v === 'number') return v;
        if (!v || String(v).trim() === "") return 0;
        let n = parseFloat(String(v).replace(/,/g, ''));
        return isNaN(n) ? 0 : n;
    };
    const safeArr = (arr) => (Array.isArray(arr) && arr.length >= 12) ? arr : new Array(12).fill(null);

    /* =========================================
       1. 実績管理 (一切触れていません)
    ========================================= */
    function getPerfVal(region, itemK, type) {
        if (type === '達成率') {
            const b = safeArr(getPerfVal(region, itemK, '予算')), a = safeArr(getPerfVal(region, itemK, '実績'));
            return a.map((v, i) => (b[i]==null||v==null)?null:(b[i]===0?0:(v/b[i])*100));
        }
        if (itemK === '待機率') {
            const w = safeArr(getPerfVal(region, 'プロパー(待機)', '実績')), t = safeArr(getPerfVal(region, 'エンジニア総数', '実績'));
            return w.map((v, i) => (t[i]==null||v==null)?null:(t[i]===0?0:(v/t[i])*100));
        }
        if (itemK === '稼働エンジニア数') {
            const p = safeArr(getPerfVal(region, 'プロパー(稼働)', type)), b = safeArr(getPerfVal(region, 'BP', '実績'));
            return type==='予算'?p:p.map((v,i)=>(v===null&&b[i]===null)?null:(v||0)+(b[i]||0));
        }
        if (itemK === 'エンジニア総数') {
            const wk = safeArr(getPerfVal(region, '稼働エンジニア数', type)), wt = safeArr(getPerfVal(region, 'プロパー(待機)', type));
            return wk.map((v,i)=>(v===null&&wt[i]===null)?null:(v||0)+(wt[i]||0));
        }
        let val = perfMap[`${region}-${itemK}-${type}`];
        if (!val && region === '全国') {
            val = perfMap[`全国合計-${itemK}-${type}`];
            if (!val) val = perfMap[`全国-${itemK}-${type}`];
        }
        return safeArr(val);
    }

    function renderPerf() {
        const region = document.getElementById('region-select').value, tbody = document.getElementById('perf-body'); tbody.innerHTML = '';
        const items = [{n:'売上',k:'売上',t:['予算','実績','達成率']},{n:'稼働原価',k:'稼働原価',t:['予算','実績','達成率']},{n:'A利益',k:'A利益',t:['予算','実績','達成率']},{n:'待機原価',k:'待機原価',t:['実績']},{n:'プロパー(稼働)',k:'プロパー(稼働)',t:['予算','実績','達成率']},{n:'BP',k:'BP',t:['実績']},{n:'稼働エンジニア数',k:'稼働エンジニア数',t:['予算','実績']},{n:'プロパー(待機)',k:'プロパー(待機)',t:['予算','実績']},{n:'待機率',k:'待機率',t:['実績']},{n:'エンジニア総数',k:'エンジニア総数',t:['予算','実績','達成率']}];
        const sumF = (arr) => {
            let hasVal = false;
            let s = arr.reduce((a,b) => { if(b !== null && b !== undefined) { hasVal = true; return a + b; } return a; }, 0);
            return hasVal ? s : null;
        };
        items.forEach(item => {
            item.t.forEach((type, idx) => {
                const tr = document.createElement('tr');
                if (idx === item.t.length - 1) tr.classList.add('bb-4px');
                if (type === '予算') tr.classList.add('bb-2px');
                if (type === '実績') { if (item.t.includes('予算')) tr.classList.add('bt-2px'); tr.classList.add('bb-3px'); }
                if (type === '達成率') tr.classList.add('bt-3px');
                let html = idx===0?`<td rowspan="${item.t.length}" class="cat-header sticky-left">${item.n}</td>` : '';
                html += `<td class="text-center sticky-left-2">${type}</td>`;
                const data = getPerfVal(region, item.k, type);
                let h1 = null, h2 = null, tot = null;
                if (type === '達成率' || item.k === '待機率') {
                    const bD = getPerfVal(region, (type==='達成率'?item.k:'エンジニア総数'), (type==='達成率'?'予算':'実績'));
                    const aD = getPerfVal(region, (type==='達成率'?item.k:'プロパー(待機)'), '実績');
                    const sumA1 = sumF(aD.slice(0,6)), sumB1 = sumF(bD.slice(0,6));
                    const sumA2 = sumF(aD.slice(6,12)), sumB2 = sumF(bD.slice(6,12));
                    const sumAT = sumF(aD), sumBT = sumF(bD);
                    h1 = sumB1 ? (sumA1 / sumB1) * 100 : (sumB1 === 0 ? 0 : null);
                    h2 = sumB2 ? (sumA2 / sumB2) * 100 : (sumB2 === 0 ? 0 : null);
                    tot = sumBT ? (sumAT / sumBT) * 100 : (sumBT === 0 ? 0 : null);
                } else { h1 = sumF(data.slice(0,6)); h2 = sumF(data.slice(6,12)); tot = sumF(data); }
                for(let i=0;i<12;i++) {
                    const bCls = (i < 5 || (i >= 6 && i < 11)) ? 'br-3px ' : '';
                    const bClsL = (i > 0 && i !== 6) ? 'bl-3px ' : '';
                    html += `<td class="text-right ${bCls} ${bClsL}">${formatVal(data[i],item.k,type)}</td>`;
                    if(i===5) html += `<td class="text-right col-total">${formatVal(h1,item.k,type)}</td>`;
                    if(i===11) html += `<td class="text-right col-total">${formatVal(h2,item.k,type)}</td>`;
                }
                html += `<td class="text-right col-total">${formatVal(tot,item.k,type)}</td>`;
                tr.innerHTML = html; tbody.appendChild(tr);
            });
        });
        updateCharts(region);
    }

    function formatVal(v, k, t) { 
        if (v === null || v === undefined || v === "") return '-'; 
        if (k === '待機率' || t === '達成率') return (v || 0).toFixed(1) + '%'; 
        return Math.round(v).toLocaleString(); 
    }

    /* =========================================
       2. 営業推進管理表 (修正対象：右詰め、幅最適化)
    ========================================= */
    function renderSales() {
        if (!salesRows || salesRows.length < 10) return;
        const region = document.getElementById('sales-region-select').value;
        const searchKeyword = document.getElementById('sales-search').value.toLowerCase(); 
        const head = document.getElementById('sales-head'), body = document.getElementById('sales-body');
        const allData = salesRows.slice(9), headers = allData[0], rawData = allData.slice(1);
        
        let hHtml = "<tr>";
        hHtml += `<th rowspan="2" class="col-sales-aff">${headers[1] || "所属"}</th>`;
        hHtml += `<th rowspan="2" class="col-sales-name">${headers[4] || "技術者名"}<br>${headers[3] || "技術者№"}</th>`;
        hHtml += `<th rowspan="2" class="col-sales-info">給料<br>コスト</th>`;
        for (let i = 12; i < 36; i += 2) {
            hHtml += `<th>${headers[i] || ""}</th>`;
            if (i === 22) hHtml += `<th rowspan="2" class="col-total">上期計</th>`;
            if (i === 34) {
                hHtml += `<th rowspan="2" class="col-total">下期計</th>`;
                hHtml += `<th rowspan="2" class="col-total">年間計</th>`;
            }
        }
        hHtml += "</tr><tr>";
        for (let i = 12; i < 36; i += 2) { hHtml += `<th>売上<br>利益</th>`; }
        hHtml += "</tr>"; head.innerHTML = hHtml;
        
        let filteredRows = rawData.filter(row => {
            const name = String(row[4] || "").trim();
            const aff1 = String(row[1] || "").trim();
            const aff2 = String(row[2] || "").trim();
            
            if (!name || name === "技術者名" || name === "0" || name === "総合計") return false;
            if (aff1.includes("売上") || aff1.includes("原価") || aff1.includes("利益") || aff1.includes("計")) return false;
            if (aff2.includes("売上") || aff2.includes("原価") || aff2.includes("利益") || aff2.includes("計")) return false;

            if (region !== "全国") {
                const searchStr = (String(row[0]||"") + aff1 + aff2).trim();
                const map = { 
                    "東海": ["東海", "静岡"], 
                    "首都圏": ["首都圏", "東京", "本社", "本店"], 
                    "東日本": ["東海", "静岡", "首都圏", "東京", "本社", "本店"], 
                    "西日本": ["西日本", "大阪"] 
                };
                const targets = map[region] || [region];
                if (!targets.some(t => searchStr.includes(t))) return false;
            }

            if (searchKeyword && !row.join('').toLowerCase().includes(searchKeyword)) return false;
            return true;
        });

        // 総合計の計算
        let monthlyTotals = [];
        for (let i = 12; i < 36; i += 2) {
            let sSum = 0, pSum = 0;
            filteredRows.forEach(row => {
                let sRaw = row[i];
                let cRaw = row[i+1];
                if (sRaw !== null && sRaw !== undefined && String(sRaw).trim() !== "") {
                    const s = Math.floor(parseNum(sRaw));
                    const c = Math.floor(parseNum(cRaw));
                    sSum += s;
                    pSum += (s - c);
                }
            });
            monthlyTotals.push({ sales: sSum, profit: pSum });
        }

        let totalSal = 0, totalCos = 0;
        filteredRows.forEach(row => {
            totalSal += Math.floor(parseNum(row[10]));
            totalCos += Math.floor(parseNum(row[11]));
        });

        const border2pxTop = "border-bottom: 2px solid black !important;";
        const border2pxBottom = "border-top: 2px solid black !important;";

        let bHtml = "";

        // 総合計行 (すべて text-right に変更)
        bHtml += "<tr><td colspan='2' rowspan='2' class='text-center col-sales-aff' style='font-weight:bold;'>総合計</td>";
        bHtml += `<td class="text-right col-sales-info" style="font-weight:bold; ${border2pxTop}">${totalSal.toLocaleString()}</td>`;
        let gH1S = 0, gH1P = 0, gH2S = 0, gH2P = 0;
        monthlyTotals.forEach((t, idx) => {
            bHtml += `<td class="text-right" style="font-weight:bold; ${border2pxTop}">${t.sales.toLocaleString()}</td>`;
            if (idx < 6) gH1S += t.sales; else gH2S += t.sales;
            if (idx === 5) bHtml += `<td class="text-right col-total" style="${border2pxTop}">${gH1S.toLocaleString()}</td>`;
            if (idx === 11) {
                bHtml += `<td class="text-right col-total" style="${border2pxTop}">${gH2S.toLocaleString()}</td>`;
                bHtml += `<td class="text-right col-total" style="${border2pxTop}">${(gH1S+gH2S).toLocaleString()}</td>`;
            }
        });
        bHtml += "</tr><tr>";
        bHtml += `<td class="text-right col-sales-info" style="font-weight:bold; ${border2pxBottom}">${totalCos.toLocaleString()}</td>`;
        monthlyTotals.forEach((t, idx) => {
            bHtml += `<td class="text-right" style="font-weight:bold; ${border2pxBottom}">${t.profit.toLocaleString()}</td>`;
            if (idx < 6) gH1P += t.profit; else gH2P += t.profit;
            if (idx === 5) bHtml += `<td class="text-right col-total" style="${border2pxBottom}">${gH1P.toLocaleString()}</td>`;
            if (idx === 11) {
                bHtml += `<td class="text-right col-total" style="${border2pxBottom}">${gH2P.toLocaleString()}</td>`;
                bHtml += `<td class="text-right col-total" style="${border2pxBottom}">${(gH1P+gH2P).toLocaleString()}</td>`;
            }
        });
        bHtml += "</tr>";

        // 各個人のデータ行 (すべて text-right に変更)
        filteredRows.forEach(row => {
            let affDisplay = row[1] || "";
            if ((affDisplay === '東海' || affDisplay === '首都圏') && row[2] === 'BP') affDisplay = 'BP' + affDisplay;

            bHtml += "<tr>";
            bHtml += `<td rowspan="2" class="text-center col-sales-aff">${affDisplay}</td>`;
            bHtml += `<td class="text-center col-sales-name" style="${border2pxTop}">${row[4] || ""}</td>`;
            
            const sal = Math.floor(parseNum(row[10]));
            bHtml += `<td class="text-right col-sales-info" style="${border2pxTop}">${(sal === 0 && !row[10]) ? "-" : sal.toLocaleString()}</td>`;
            
            let s1=0, s2=0;
            for (let i = 12; i < 36; i += 2) {
                let sRaw = row[i];
                let sStr = "-";
                let ns = 0;
                if (sRaw !== null && sRaw !== undefined && String(sRaw).trim() !== "") {
                    ns = Math.floor(parseNum(sRaw));
                    sStr = ns.toLocaleString();
                    if (i <= 22) s1 += ns; else s2 += ns;
                }
                bHtml += `<td class="text-right" style="${border2pxTop}">${sStr}</td>`;
                if (i === 22) bHtml += `<td class="text-right col-total" style="${border2pxTop}">${s1.toLocaleString()}</td>`;
                if (i === 34) {
                    bHtml += `<td class="text-right col-total" style="${border2pxTop}">${s2.toLocaleString()}</td>`;
                    bHtml += `<td class="text-right col-total" style="${border2pxTop}">${(s1+s2).toLocaleString()}</td>`;
                }
            }
            bHtml += "</tr><tr>";
            bHtml += `<td class="text-center col-sales-name" style="${border2pxBottom}">${row[3] || ""}</td>`;
            
            const cos = Math.floor(parseNum(row[11]));
            bHtml += `<td class="text-right col-sales-info" style="${border2pxBottom}">${(cos === 0 && !row[11]) ? "-" : cos.toLocaleString()}</td>`;
            
            let p1=0, p2=0;
            for (let i = 12; i < 36; i += 2) {
                let sRaw = row[i];
                let cRaw = row[i+1];
                let pStr = "-";
                let np = 0;
                // 売上が入力されている場合のみ利益を計算する
                if (sRaw !== null && sRaw !== undefined && String(sRaw).trim() !== "") {
                    let ns = Math.floor(parseNum(sRaw));
                    let nc = Math.floor(parseNum(cRaw));
                    np = ns - nc;
                    pStr = np.toLocaleString();
                    if (i <= 22) p1 += np; else p2 += np;
                }
                bHtml += `<td class="text-right" style="${border2pxBottom}">${pStr}</td>`;
                if (i === 22) bHtml += `<td class="text-right col-total" style="${border2pxBottom}">${p1.toLocaleString()}</td>`;
                if (i === 34) {
                    bHtml += `<td class="text-right col-total" style="${border2pxBottom}">${p2.toLocaleString()}</td>`;
                    bHtml += `<td class="text-right col-total" style="${border2pxBottom}">${(p1+p2).toLocaleString()}</td>`;
                }
            }
            bHtml += "</tr>";
        });
        body.innerHTML = bHtml;
    }

    /* =========================================
       3. 売込状況一覧 (一切触れていません)
    ========================================= */
    function renderStatus() {
        const tbody = document.getElementById('status-body'), reg = document.getElementById('status-region-select').value;
        tbody.innerHTML = '';
        if (!statusRows || statusRows.length <= 1) { tbody.innerHTML = '<tr><td colspan="7" class="text-center">データ取得中...</td></tr>'; return; }
        document.getElementById('status-update-date').innerText = "更新日: " + (formatStatusDate(statusRows[0][8]) || "-");
        let filtered = statusRows.slice(1).filter(r => {
            const rowText = (String(r[0]||"") + String(r[1]||"")).trim();
            if (!rowText || rowText.includes("所属") || rowText.includes("従業員")) return false;
            if (reg === "全国") return true;
            const map = { "東海": ["東海", "静岡"], "首都圏": ["首都圏", "東京", "本社", "本店"], "東日本": ["東海", "静岡", "首都圏", "東京", "本社", "本店"], "西日本": ["西日本", "大阪"] };
            const targets = map[reg] || [reg];
            return targets.some(t => rowText.includes(t));
        });
        const order = { "待機中": 1, "休業中": 2, "休職中": 3, "稼働中": 4 };
        filtered.sort((a, b) => (order[String(a[2]).trim()]||99) - (order[String(b[2]).trim()]||99));
        filtered.forEach(row => {
            const tr = document.createElement('tr');
            const st = String(row[2] || "").trim();
            if (st === "待機中") tr.classList.add('status-wait'); else if (st === "稼働中") tr.classList.add('status-active');
            let aff = String(row[1]||""), name = String(row[0]||"");
            const known = ['東海', '静岡', '首都圏', '本社', '本店', '東京', '西日本', '大阪'];
            if (known.some(v => name.includes(v))) { aff = name; name = String(row[1]||""); }
            const sal = parseNum(row[6]);
            tr.innerHTML = `<td class="text-center">${aff}</td><td class="text-center" style="font-weight:bold;">${name}</td><td class="text-center">${sal === 0 && !row[6] ? "-" : sal.toLocaleString()}</td><td class="text-center">${st}</td><td class="text-center">${row[3]||""}</td><td class="text-center">${formatStatusDate(row[4])}</td><td class="text-center">${row[5]||0}ヶ月</td>`;
            tbody.appendChild(tr);
        });
    }

    function formatStatusDate(val) {
        if (!val || val === "-") return "-";
        let d = typeof val === 'number' ? new Date((val - 25569) * 86400 * 1000) : new Date(val);
        if (!isNaN(d.getTime())) return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
        return val;
    }

    function updateCharts(region) {
        const labels = ['6月','7月','8月','9月','10月','11月','12月','1月','2月','3月','4月','5月'];
        const opt = (title) => ({ responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: title, font: { size: 18, weight: 'bold' }, color: '#2d3748', padding: { bottom: 10 } } } });
        if (charts.s) charts.s.destroy(); charts.s = new Chart(document.getElementById('salesChart').getContext('2d'), { type: 'bar', data: { labels, datasets: [{ label: '実績', data: getPerfVal(region, '売上', '実績'), backgroundColor: '#3182ce' },{ label: '予算', data: getPerfVal(region, '売上', '予算'), type: 'line', borderColor: '#e53e3e', pointBackgroundColor: '#e53e3e' }]}, options: opt('売上推移') });
        if (charts.e) charts.e.destroy(); charts.e = new Chart(document.getElementById('engChart').getContext('2d'), { type: 'bar', data: { labels, datasets: [{ label: 'プロパー(稼働)', data: getPerfVal(region, 'プロパー(稼働)', '実績'), backgroundColor: '#3182ce' },{ label: 'BP', data: getPerfVal(region, 'BP', '実績'), backgroundColor: '#ed64a6' },{ label: 'プロパー(待機)', data: getPerfVal(region, 'プロパー(待機)', '実績'), backgroundColor: '#a0aec0' }]}, options: { ...opt('エンジニア内訳'), scales: { x: { stacked: true }, y: { stacked: true } } } });
        if (charts.w) charts.w.destroy(); charts.w = new Chart(document.getElementById('waitCostChart').getContext('2d'), { type: 'line', data: { labels, datasets: [{ label: '待機原価推移', data: getPerfVal(region, '待機原価', '実績'), borderColor: '#ed8936', pointBackgroundColor: '#ed8936', fill: true, backgroundColor: 'rgba(237,137,54,0.1)' }]}, options: opt('待機原価推移') });
    }
</script>
</body>
</html>



