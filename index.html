<!DOCTYPE html>
<html lang="ja" class="notranslate">
<head>
    <meta charset="UTF-8">
    <title>Freeeks 統合管理ポータル</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Hiragino Sans', sans-serif; background-color: #f0f4f8; padding: 0; margin: 0; color: #333; }
        #pw_screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a202c; display: flex; justify-content: center; align-items: center; z-index: 10000; }
        #pw_box { background: white; padding: 40px; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        #main_content { display: none; }
        
        .nav-bar { background: #2d3748; padding: 0 20px; display: flex; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 1000; }
        .nav-item { padding: 18px 25px; color: #a0aec0; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; transition: 0.3s; }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-item.active { color: white; border-bottom: 3px solid #3182ce; background: rgba(255,255,255,0.05); }
        #sync_status { font-size: 12px; color: #cbd5e0; margin-left: auto; }
        
        .container { padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow-x: auto; margin-bottom: 25px; }
        
        /* --- 共通枠線デザイン --- */
        table { border-collapse: collapse; background: white; border: 4px solid black !important; font-size: 0.8rem; }
        th, td { border: 1px solid black; border-left: 4px solid black !important; border-right: 4px solid black !important; padding: 8px 4px; white-space: nowrap; }
        th { background: #edf2f7; text-align: center; border-bottom: 4px solid black !important; position: sticky; top: 0; z-index: 20; }
        
        /* 営業推進：特定列の固定 */
        .sticky-left { position: sticky; left: 0; background: white !important; z-index: 30; border-right: 4px solid black !important; }
        .sticky-left-2 { position: sticky; left: 100px; background: white !important; z-index: 30; border-right: 4px solid black !important; }

        .text-right { text-align: right !important; }
        .text-center { text-align: center !important; }
        .profit-low { color: red; font-weight: bold; }
        .status-badge { padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; }

        .search-box { margin-bottom: 15px; padding: 10px; border: 2px solid #cbd5e0; border-radius: 8px; width: 300px; font-size: 1rem; }
        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 350px; }
    </style>
</head>
<body class="notranslate">

<div id="pw_screen">
    <div id="pw_box">
        <h2 style="margin:0 0 20px 0;">Freeeks 営業実績管理システム</h2>
        <input type="password" id="pass_val" style="padding:12px; font-size:18px; border:2px solid #ddd; border-radius:6px; width:220px;" onkeydown="if(event.keyCode==13)checkPW()">
        <br><br>
        <button onclick="checkPW()" style="padding:12px 35px; background:#3182ce; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">ログイン</button>
        <p id="err_msg" style="color:red; display:none; margin-top:10px;">パスワードが違います</p>
    </div>
</div>

<div id="main_content">
    <div class="nav-bar">
        <div class="nav-item active" id="tab-performance" onclick="switchTab('performance')">実績管理</div>
        <div class="nav-item" id="tab-sales" onclick="switchTab('sales')">営業推進</div>
        <div id="sync_status">データ同期中...</div>
    </div>

    <div class="container">
        <div id="section-performance">
            <div class="card">
                <div style="display:flex; align-items:center; margin-bottom:20px;">
                    <h2 style="margin:0; border-left:5px solid #3182ce; padding-left:15px; margin-right: 25px;">拠点別実績・予算</h2>
                    <select id="region-select" style="padding:8px 15px; border-radius:6px; font-size:1rem;" onchange="renderPerformance()">
                        <option value="全体合計">全体合計</option>
                        <option value="東海">東海</option>
                        <option value="首都圏">首都圏</option>
                        <option value="東日本">東日本</option>
                        <option value="西日本">西日本</option>
                    </select>
                </div>
                <table id="performance-table">
                    <thead>
                        <tr>
                            <th rowspan="2" style="width:130px;">項目</th>
                            <th rowspan="2" style="width:70px;">区分</th>
                            <th colspan="6">上期実績</th><th style="background:#fffaf0;">上期計</th>
                            <th colspan="6" style="border-left:4px solid black !important;">下期実績</th><th style="background:#fffaf0;">下期計</th>
                            <th style="background:#fffaf0;">年間計</th>
                        </tr>
                        <tr>
                            <th>6月</th><th>7月</th><th>8月</th><th>9月</th><th>10月</th><th style="border-right:4px solid black !important;">11月</th><th>計</th>
                            <th style="border-left:4px solid black !important;">12月</th><th>1月</th><th>2月</th><th>3月</th><th>4月</th><th style="border-right:4px solid black !important;">5月</th><th>計</th>
                            <th>合計</th>
                        </tr>
                    </thead>
                    <tbody id="performance-body"></tbody>
                </table>
            </div>
            <div class="charts-container">
                <div class="chart-box"><canvas id="salesChart"></canvas></div>
                <div class="chart-box"><canvas id="engChart"></canvas></div>
                <div class="chart-box"><canvas id="waitCostChart"></canvas></div>
            </div>
        </div>

        <div id="section-sales" style="display:none;">
            <div class="card">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
                    <h2 style="margin:0; border-left:5px solid #48bb78; padding-left:15px;">営業推進管理表 (粗利・粗利率 自動計算)</h2>
                    <input type="text" id="sales-search" class="search-box" placeholder="技術者名・企業名で検索..." oninput="renderSalesPromotion()">
                </div>
                <div style="overflow-x: auto; max-height: 700px;">
                    <table id="sales-promotion-table">
                        <thead id="promotion-head"></thead>
                        <tbody id="promotion-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzLPhdnyAo1D7SH-T3uv0EOb5aWekcfnFRtReGhsnkQ5_sLbi36fTc6o5eVYukeliVJIA/exec';
    let perfMap = {};
    let salesRows = [];
    let charts = {};

    window.onload = () => {
        const cP = localStorage.getItem('f_perf');
        const cS = localStorage.getItem('f_sales');
        if(cP) perfMap = JSON.parse(cP);
        if(cS) salesRows = JSON.parse(cS);
        fetchAll();
    };

    function checkPW() {
        if (document.getElementById('pass_val').value === "freeeks2022") {
            document.getElementById('pw_screen').style.display = 'none';
            document.getElementById('main_content').style.display = 'block';
            renderAll();
        } else { document.getElementById('err_msg').style.display = 'block'; }
    }

    function switchTab(tab) {
        document.getElementById('section-performance').style.display = tab === 'performance' ? 'block' : 'none';
        document.getElementById('section-sales').style.display = tab === 'sales' ? 'block' : 'none';
        document.getElementById('tab-performance').className = 'nav-item' + (tab === 'performance' ? ' active' : '');
        document.getElementById('tab-sales').className = 'nav-item' + (tab === 'sales' ? ' active' : '');
        renderAll();
    }

    async function fetchAll() {
        try {
            const [rP, rS] = await Promise.all([
                fetch(`${GAS_URL}?p=freeeks2022&s=実績データ`),
                fetch(`${GAS_URL}?p=freeeks2022&s=営業推進管理表`)
            ]);
            const rowsP = await rP.json();
            perfMap = {};
            rowsP.slice(1).forEach(r => {
                perfMap[`${r[0]}-${r[1]}-${r[2]}`] = r.slice(3, 15).map(v => (v===""||v==null)?null:parseFloat(String(v).replace(/,/g,''))||0);
            });
            salesRows = await rS.json();
            localStorage.setItem('f_perf', JSON.stringify(perfMap));
            localStorage.setItem('f_sales', JSON.stringify(salesRows));
            document.getElementById('sync_status').innerText = '最新データ同期完了';
            renderAll();
        } catch (e) { document.getElementById('sync_status').innerText = 'キャッシュ表示中'; }
    }

    function renderAll() {
        if (document.getElementById('section-performance').style.display !== 'none') renderPerformance();
        if (document.getElementById('section-sales').style.display !== 'none') renderSalesPromotion();
    }

    /* --- 実績管理用 --- */
    function getPerfVal(region, itemK, type) {
        if (type === '達成率') {
            const b = getPerfVal(region, itemK, '予算'), a = getPerfVal(region, itemK, '実績');
            return a.map((v, i) => (b[i]==null||v==null)?null:(b[i]===0?0:(v/b[i])*100));
        }
        if (itemK === '待機率') {
            const w = getPerfVal(region, 'プロパー(待機)', '実績'), t = getPerfVal(region, 'エンジニア総数', '実績');
            return w.map((v, i) => (t[i]==null||v==null)?null:(t[i]===0?0:(v/t[i])*100));
        }
        if (region === '全体合計') {
            let sum = new Array(12).fill(null);
            ['東海','首都圏','西日本'].forEach(reg => {
                getPerfVal(reg, itemK, type).forEach((v,i) => { if(v!==null) sum[i]=(sum[i]||0)+v; });
            });
            return sum;
        }
        return perfMap[`${region}-${itemK}-${type}`] || new Array(12).fill(null);
    }

    function renderPerformance() {
        const region = document.getElementById('region-select').value;
        const tbody = document.getElementById('performance-body');
        tbody.innerHTML = '';
        const items = [
            {n:'売上',k:'売上',t:['予算','実績','達成率']},
            {n:'A利益',k:'A利益',t:['予算','実績','達成率']},
            {n:'待機原価',k:'待機原価',t:['実績']},
            {n:'エンジニア総数',k:'エンジニア総数',t:['予算','実績','達成率']}
        ];
        items.forEach(item => {
            item.t.forEach((type, idx) => {
                const tr = document.createElement('tr');
                if(idx===item.t.length-1) tr.className='bb-4px';
                let html = idx===0?`<td rowspan="${item.t.length}" class="text-center" style="background:#ebf8ff; font-weight:bold;">${item.n}</td>` : '';
                html += `<td class="text-center">${type}</td>`;
                const data = getPerfVal(region, item.k, type);
                data.forEach((v, i) => {
                    html += `<td class="text-right" ${(i===5||i===11)?'style="border-right:4px solid black !important;"':''}>${formatVal(v,item.k,type)}</td>`;
                });
                tr.innerHTML = html; tbody.appendChild(tr);
            });
        });
        updateCharts(region);
    }

    /* --- 営業推進管理表（加工ロジック入り） --- */
    function renderSalesPromotion() {
        if (!salesRows || salesRows.length < 2) return;
        const head = document.getElementById('promotion-head');
        const body = document.getElementById('promotion-body');
        const query = document.getElementById('sales-search').value.toLowerCase();
        
        // ヘッダー（2段）
        let headHtml = `<tr>
            <th rowspan="2" class="sticky-left" style="width:40px;">NO</th>
            <th rowspan="2" class="sticky-left-2" style="width:100px;">所属 / 技術者</th>
            <th rowspan="2">取引先</th>
            <th rowspan="2">更新状況</th>`;
        
        // 月ごとのヘッダー（売上・原価・粗利）
        for (let i = 5; i < salesRows[0].length; i += 2) {
            const monthLabel = salesRows[0][i];
            headHtml += `<th colspan="4">${monthLabel}</th>`;
        }
        headHtml += `</tr><tr>`;
        for (let i = 5; i < salesRows[0].length; i += 2) {
            headHtml += `<th>売上</th><th>原価</th><th style="background:#fefcbf;">粗利</th><th style="background:#fefcbf;">%</th>`;
        }
        headHtml += `</tr>`;
        head.innerHTML = headHtml;

        // ボディ
        let bodyHtml = "";
        salesRows.slice(2).forEach((row, rowIndex) => {
            // 検索フィルタ
            const searchContent = (row[1] + row[2] + row[3]).toLowerCase();
            if (query && !searchContent.includes(query)) return;

            bodyHtml += `<tr>`;
            bodyHtml += `<td class="text-center sticky-left">${row[0] || ""}</td>`;
            bodyHtml += `<td class="sticky-left-2"><b>${row[1] || ""}</b><br>${row[2] || ""}</td>`;
            bodyHtml += `<td>${row[3] || "-"}</td>`;
            bodyHtml += `<td class="text-center"><span class="status-badge" style="background:#edf2f7;">${row[4] || "-"}</span></td>`;

            // 月次データの計算・加工表示
            for (let i = 5; i < row.length; i += 2) {
                const s = parseFloat(row[i]) || 0;
                const c = parseFloat(row[i+1]) || 0;
                const profit = s - c;
                const margin = s > 0 ? (profit / s) * 100 : 0;

                bodyHtml += `<td class="text-right">${s > 0 ? s.toLocaleString() : "-"}</td>`;
                bodyHtml += `<td class="text-right">${c > 0 ? c.toLocaleString() : "-"}</td>`;
                bodyHtml += `<td class="text-right" style="background:#fefcbf; font-weight:bold;">${profit !== 0 ? profit.toLocaleString() : "-"}</td>`;
                bodyHtml += `<td class="text-right ${margin < 20 && s > 0 ? 'profit-low' : ''}" style="background:#fefcbf;">${s > 0 ? margin.toFixed(1) + '%' : "-"}</td>`;
            }
            bodyHtml += `</tr>`;
        });
        body.innerHTML = bodyHtml;
    }

    function formatVal(v, k, t) {
        if (v === null || (v === 0 && k !== '待機率' && t !== '達成率')) return '-';
        if (k === '待機率' || t === '達成率') return v.toFixed(1) + '%';
        return Math.round(v).toLocaleString();
    }

    function updateCharts(region) {
        renderChart('salesChart', '売上推移', [
            { label: '実績', data: getPerfVal(region, '売上', '実績'), type: 'bar', backgroundColor: '#3182ce' },
            { label: '予算', data: getPerfVal(region, '売上', '予算'), type: 'line', borderColor: '#e53e3e' }
        ]);
        renderChart('engChart', 'エンジニア数', [
            { label: '稼働', data: getPerfVal(region, 'エンジニア総数', '実績'), type: 'bar', backgroundColor: '#48bb78' }
        ]);
        renderChart('waitCostChart', '待機原価', [
            { label: '実績', data: getPerfVal(region, '待機原価', '実績'), type: 'line', borderColor: '#ed8936', fill:true, backgroundColor:'rgba(237,137,54,0.1)' }
        ]);
    }

    function renderChart(id, title, datasets) {
        const ctx = document.getElementById(id).getContext('2d');
        if (charts[id]) charts[id].destroy();
        charts[id] = new Chart(ctx, {
            type: 'bar', data: { labels: ['6月','7月','8月','9月','10月','11月','12月','1月','2月','3月','4月','5月'], datasets: datasets },
            options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: title } } }
        });
    }
</script>
</body>
</html>





