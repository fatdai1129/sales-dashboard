<!DOCTYPE html>
<html lang="ja" class="notranslate">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <title>Freeeks 営業実績管理システム</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        #pw_screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2d3748; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; }
        #pw_box { padding: 30px; background: white; border-radius: 12px; color: #333; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .pw-title { font-size: 1.2rem; font-weight: bold; color: #2d3748; margin-bottom: 5px; }
        input#pass_val { padding: 12px; font-size: 18px; border: 2px solid #ddd; border-radius: 6px; margin-bottom: 15px; width: 220px; text-align: center; }
        button.login-btn { padding: 12px 25px; background: #3182ce; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; }
        #main_content { display: none; }
        body { font-family: 'Hiragino Sans', sans-serif; background-color: #f0f4f8; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1700px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; overflow-x: auto; }
        h2 { font-size: 1.4rem; margin: 0; color: #1a202c; border-left: 5px solid #3182ce; padding-left: 15px; }
        select { padding: 8px 15px; border-radius: 6px; border: 1px solid #cbd5e0; font-size: 1rem; }
        
        /* 枠線の強化設定  */
        table { width: 100%; border-collapse: collapse; min-width: 1500px; background: white; border: 2px solid #4a5568; }
        th, td { border: 1px solid #e2e8f0; padding: 6px 4px; text-align: right; font-size: 0.8rem; }
        th { background: #edf2f7; color: #4a5568; text-align: center; border-bottom: 2px solid #4a5568 !important; }
        
        /* 垂直境界線の太線化（赤丸箇所）  */
        .cat-header { background: #ebf8ff; font-weight: bold; text-align: center; color: #2c5282; border-right: 2px solid #4a5568 !important; border-bottom: 2px solid #4a5568 !important; }
        .type-col { text-align: center; border-right: 2px solid #4a5568 !important; }
        .month-sep { border-right: 2px solid #4a5568 !important; } /* 11月と5月の右側 */
        
        .total-header { background: #edf2f7; color: #4a5568; text-align: center; font-weight: bold; border-left: 2px solid #4a5568 !important; border-right: 2px solid #4a5568 !important; }
        .total-col { background: #fffaf0; font-weight: bold; text-align: right; border-left: 2px solid #4a5568 !important; border-right: 2px solid #4a5568 !important; }
        
        /* 項目ごとの最下部太線  */
        .item-bottom-border td { border-bottom: 2px solid #4a5568 !important; }
        
        .fixed-val { background: #f8fafc; color: #4a5568; }
        .chart-box { height: 400px; width: 100%; margin-bottom: 20px; position: relative; }
    </style>
</head>
<body class="notranslate">
<div id="pw_screen">
    <div id="pw_box">
        <div class="pw-title">【Freeeks実績管理】</div>
        <h3 style="margin-top:0">閲覧にはパスワードが必要です</h3>
        <input type="password" id="pass_val" placeholder="パスワードを入力" onkeydown="if(event.keyCode==13)checkPW()">
        <br>
        <button class="login-btn" onclick="checkPW()">ログイン</button>
        <p id="err_msg" style="color: red; display: none; margin-top:10px;">パスワードが違います</p>
    </div>
</div>
<div id="main_content" class="container">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 id="display-title">全社 営業実績・予算管理表</h2>
            <select id="region-select" onchange="changeRegion()">
                <option value="total">全社</option>
                <option value="west">西日本</option>
                <option value="tokai">東海</option>
                <option value="tokyo">首都圏</option>
            </select>
        </div>
        <table>
            <thead>
                <tr>
                    <th rowspan="2" class="cat-header">項目</th>
                    <th rowspan="2" class="type-col">区分</th>
                    <th colspan="6">上期実績</th>
                    <th class="total-header">上期合計</th>
                    <th colspan="6">下期実績・予想</th>
                    <th class="total-header">下期合計</th>
                    <th class="total-header">年間合計</th>
                </tr>
                <tr>
                    <th>6月</th><th>7月</th><th>8月</th><th>9月</th><th>10月</th><th class="month-sep">11月</th>
                    <th class="total-header">計</th>
                    <th>12月</th><th>1月</th><th>2月</th><th>3月</th><th>4月</th><th class="month-sep">5月</th>
                    <th class="total-header">計</th>
                    <th class="total-header">合計</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
    <div class="card">
        <h2>売上推移グラフ</h2>
        <div class="chart-box"><canvas id="salesChart"></canvas></div>
        <hr style="border:0; border-top:1px solid #eee; margin:40px 0;">
        <h2>稼働エンジニア数</h2>
        <div class="chart-box"><canvas id="engineerChart"></canvas></div>
        <hr style="border:0; border-top:1px solid #eee; margin:40px 0;">
        <h2>待機原価推移</h2>
        <div class="chart-box"><canvas id="waitingChart"></canvas></div>
    </div>
</div>
<script>
    Chart.register(ChartDataLabels);
    function checkPW() {
        if (document.getElementById('pass_val').value === "freeeks2022") {
            document.getElementById('pw_screen').style.display = 'none';
            document.getElementById('main_content').style.display = 'block';
            renderTable();
        } else { document.getElementById('err_msg').style.display = 'block'; }
    }
    const dataSet = {
        west: {
            budget: { sales:[33284,33912,33912,34540,35168,35168,35796,35168,36424,37052,37680,38308], propK:[53,54,54,55,56,56,57,56,58,59,60,61], propW:[2,1,0,0,2,1,0,2,0,0,0,0], bpK:[0,0,0,0,0,0,0,0,0,0,0,0], waitCost:[916,458,0,0,916,458,0,916,0,0,0,0], kCost:[24274,24732,24732,25190,25648,25648,26106,25648,26564,27022,27480,27938], aProfit:[9010,9180,9180,9350,9520,9520,9690,9520,9860,10030,10200,10370] },
            actual: { sales:[30240,29690,27037,28765,25365,26662,26564,26894,null,null,null,null], propK:[48,47,45,45,42,44,43,45,null,null,null,null], propW:[3,4,5,5,9,7,8,3,null,null,null,null], bpK:[0,0,0,0,0,0,0,0,null,null,null,null], waitCost:[1329,2030,2361,2045,4120,3358,2462,558,null,null,null,null], kCost:[22264,21563,20898,21214,19139,20401,21000,21983,null,null,null,null], aProfit:[7976,8127,6139,7551,6226,6261,5564,4911,null,null,null,null] }
        },
        tokai: {
            budget: { sales:[7895,7895,8495,8495,9095,9095,9695,9695,10295,10295,10895,10845], propK:[13,13,14,14,15,15,16,16,17,17,18,18], propW:[0,0,0,0,0,0,0,0,0,0,0,0], bpK:[0,0,0,0,0,0,0,0,0,0,0,0], waitCost:[0,0,0,0,0,0,0,0,0,0,0,0], kCost:[6434,6239,6789,6789,7339,7339,7889,7889,8439,8439,8989,8989], aProfit:[1461,1656,1706,1706,1756,1756,1806,1806,1856,1856,1906,1856] },
            actual: { sales:[5996,6245,6159,6245,5655,5560,6236,8157,null,null,null,null], propK:[9,9,9,9,9,9,9,9,null,null,null,null], propW:[2,2,0,0,0,0,0,0,null,null,null,null], bpK:[1,1,1,1,1,1,2,5,null,null,null,null], waitCost:[1020,917,0,0,0,0,0,0,null,null,null,null], kCost:[4769,4968,4968,5084,4514,4464,4975,6815,null,null,null,null], aProfit:[1227,1277,1191,1161,1141,1096,1261,1342,null,null,null,null] }
        },
        tokyo: {
            budget: { sales:[16010,16660,17360,17360,18060,18060,18810,18910,18910,19610,20310,20310], propK:[27,27,28,28,29,29,30,30,30,31,32,32], propW:[0,0,0,0,0,0,0,0,0,0,0,0], bpK:[0,0,0,0,0,0,0,0,0,0,0,0], waitCost:[0,0,0,0,0,0,0,0,0,0,0,0], kCost:[14672,15272,15872,15872,16472,16472,17072,17152,17152,17752,18352,18352], aProfit:[1338,1388,1488,1488,1588,1588,1738,1758,1758,1858,1958,1958] },
            actual: { sales:[15882,17849,20286,19890,20011,20696,19434,19942,null,null,null,null], propK:[5,5,5,5,4,3,3,3,null,null,null,null], propW:[1,1,1,1,1,1,1,1,null,null,null,null], bpK:[20,21,25,26,27,30,27,28,null,null,null,null], waitCost:[220,200,200,200,200,200,200,200,null,null,null,null], kCost:[14214,15793,17296,17512,17987,19098,17336,17936,null,null,null,null], aProfit:[1668,2056,2990,2378,2024,1598,2098,2006,null,null,null,null] }
        }
    };
    const months = ["6月","7月","8月","9月","10月","11月","12月","1月","2月","3月","4月","5月"];
    let salesChart, waitingChart, engineerChart;
    function getRD(k) {
        if(dataSet[k]) return dataSet[k];
        const rs = ['west','tokai','tokyo'];
        const res = { budget:{}, actual:{} };
        ['sales','kCost','aProfit','propK','propW','bpK','waitCost'].forEach(c => {
            res.budget[c] = Array(12).fill(0).map((_,i) => rs.reduce((s,r) => s + (dataSet[r].budget[c][i]||0), 0));
            res.actual[c] = Array(12).fill(null).map((_, i) => {
                let hasVal = false, sum = 0;
                rs.forEach(r => { if(dataSet[r].actual[c][i] !== null) { hasVal = true; sum += dataSet[r].actual[c][i]; } });
                return hasVal ? sum : null;
            });
        });
        return res;
    }
    function renderTable() {
        const rk = document.getElementById('region-select').value;
        const d = getRD(rk);
        const tb = document.getElementById('table-body');
        tb.innerHTML = "";
        const labels = [
            {l:'売上',c:'sales',rows:['B','A','R']},{l:'稼働原価',c:'kCost',rows:['B','A','R']},{l:'A利益',c:'aProfit',rows:['B','A','R']},
            {l:'待機原価',c:'waitCost',rows:['A']},{l:'プロパー(稼働)',c:'propK',rows:['B','A','R']},
            {l:'BP',c:'bpK',rows:['A']},{l:'稼働エンジニア総数',c:'workEngTotal',rows:['B','A']},
            {l:'エンジニア総数',c:'totalEng',rows:['B','A','R']},{l:'プロパー(待機)',c:'propW',rows:['B','A']},{l:'待機率',c:'waitRate',rows:['A']}
        ];
        labels.forEach((item, index) => {
            const hasB = item.rows.includes('B'), hasA = item.rows.includes('A'), hasR = item.rows.includes('R');
            const rowCount = item.rows.length;
            const borderClass = "item-bottom-border";
            let rowB = `<tr><td rowspan="${rowCount}" class="cat-header ${borderClass}">${item.l}</td><td class="type-col">予算</td>`, 
                rowA = `<tr><td class="type-col">実績</td>`, rowR = `<tr class="${borderClass}"><td class="type-col">達成率</td>`;
            if(!hasB) rowA = `<tr><td rowspan="${rowCount}" class="cat-header ${borderClass}">${item.l}</td><td class="type-col">実績</td>`;
            if(!hasB && rowCount === 1) rowA = `<tr class="${borderClass}"><td class="cat-header ${borderClass}">${item.l}</td><td class="type-col">実績</td>`;
            let s1B=0, s1A=0, s2B=0, s2A=0;
            for(let i=0; i<12; i++){
                let bV = 0, aV = 0;
                if(item.c === 'workEngTotal') { bV = d.budget.propK[i] + d.budget.bpK[i]; aV = d.actual.propK[i] !== null ? (d.actual.propK[i] + (d.actual.bpK[i]||0)) : null; }
                else if(item.c === 'totalEng') { bV = d.budget.propK[i] + d.budget.propW[i] + d.budget.bpK[i]; aV = d.actual.propK[i] !== null ? (d.actual.propK[i] + (d.actual.propW[i]||0) + (d.actual.bpK[i]||0)) : null; }
                else if(item.c === 'waitRate') { aV = (d.actual.propK[i] && d.actual.propK[i] !== 0) ? (d.actual.propW[i] / d.actual.propK[i] * 100) : null; }
                else { bV = d.budget[item.c][i]; aV = d.actual[item.c][i]; }
                const sepClass = (i === 5 || i === 11) ? "month-sep" : "";
                if(hasB) { let bText = (bV === 0 && item.c==='propW') ? "0" : (bV !== 0 ? bV.toLocaleString() : ""); rowB += `<td class="fixed-val ${sepClass}">${bText}</td>`; }
                if(hasA) { 
                    let aText = ""; 
                    if(i < 8) { if(aV !== null) aText = (item.c==='waitRate') ? aV.toFixed(1)+'%' : aV.toLocaleString(); else aText = (item.c==='propW' || item.c==='waitCost') ? "0" : ""; }
                    rowA += `<td class="fixed-val ${sepClass}">${aText}</td>`; 
                }
                if(hasR) rowR += `<td class="fixed-val ${sepClass}">${aV !== null && bV !== 0 && i < 8 ? (aV/bV*100).toFixed(1)+'%' : ""}</td>`;
                if(i < 6) { s1B += bV; s1A += (aV || 0); } else { s2B += bV; s2A += (aV || 0); }
                if(i === 5) {
                    if(hasB) rowB += `<td class="total-col">${s1B !== 0 ? s1B.toLocaleString() : (item.c==='propW' ? "0":"")}</td>`;
                    if(hasA) rowA += `<td class="total-col">${s1A.toLocaleString()}</td>`;
                    if(hasR) rowR += `<td class="total-col">${s1B ? (s1A/s1B*100).toFixed(1)+'%' : ""}</td>`;
                }
            }
            if(hasB) rowB += `<td class="total-col">${s2B.toLocaleString()}</td><td class="total-col">${(s1B+s2B).toLocaleString()}</td></tr>`;
            if(hasA) rowA += `<td class="total-col">${s2A.toLocaleString()}</td><td class="total-col">${(s1A+s2A).toLocaleString()}</td></tr>`;
            if(hasR) rowR += `<td class="total-col">${s2B ? (s2A/s2B*100).toFixed(1)+'%' : ""}</td><td class="total-col">${(s1B+s2B) ? ((s1A+s2A)/(s1B+s2B)*100).toFixed(1)+'%' : ""}</td></tr>`;
            let finalRowA = rowA; if(!hasR) finalRowA = rowA.replace('<tr>', `<tr class="${borderClass}">`);
            tb.innerHTML += (hasB ? rowB : "") + finalRowA + (hasR ? rowR : "");
        });
        drawCharts();
    }
    function drawCharts() {
        const rk = document.getElementById('region-select').value;
        const d = getRD(rk);
        if(salesChart) salesChart.destroy();
        salesChart = new Chart(document.getElementById('salesChart'), {
            type:'bar', data:{ labels:months, datasets:[{label:'予算',data:d.budget.sales,backgroundColor:'#cbd5e0'},{label:'実績',data:d.actual.sales.map((v,i) => i < 8 ? v : undefined),backgroundColor:'#3182ce'}] },
            options:{ responsive:true, maintainAspectRatio:false, plugins: { datalabels: { anchor: 'end', align: 'top', formatter: (v) => v.toLocaleString(), display: (ctx) => ctx.dataset.data[ctx.dataIndex] !== undefined } } }
        });
        if(engineerChart) engineerChart.destroy();
        engineerChart = new Chart(document.getElementById('engineerChart'), {
            type:'bar', data:{ labels:months, datasets:[{label:'プロパー(稼働)',data:d.actual.propK.map((v,i) => i < 8 ? v : undefined),backgroundColor:'#10b981', datalabels: { align: 'center', anchor: 'center' }},{label:'BP',data:d.actual.bpK.map((v,i) => i < 8 ? v : undefined),backgroundColor:'#8b5cf6', datalabels: { align: 'center', anchor: 'center' }}] },
            options:{ responsive:true, maintainAspectRatio:false, scales: { x: { stacked: true }, y: { stacked: true } }, plugins: { datalabels: { color: '#fff', font: { weight: 'bold' }, display: (ctx) => ctx.dataset.data[ctx.dataIndex] !== undefined }, tooltip: { callbacks: { footer: (items) => '合計: ' + items.reduce((a, b) => a + b.parsed.y, 0) } } } },
            plugins: [{ afterDraw: (chart) => { const {ctx, scales: {y}} = chart; chart.data.labels.forEach((label, i) => { if(i >= 8) return; let total = 0, hasValue = false; chart.data.datasets.forEach(ds => { if(ds.data[i] !== undefined) { total += ds.data[i]; hasValue = true; } }); if(hasValue) { ctx.fillStyle = '#333'; ctx.font = 'bold 12px Arial'; ctx.textAlign = 'center'; ctx.fillText(total, chart.getDatasetMeta(1).data[i].x, y.getPixelForValue(total) - 10); } }); } }]
        });
        if(waitingChart) waitingChart.destroy();
        waitingChart = new Chart(document.getElementById('waitingChart'), {
            type:'bar', data:{ labels:months, datasets:[{label:'待機原価実績',data:d.actual.waitCost.map((v,i) => i < 8 ? v : undefined),backgroundColor:'#e53e3e'}] },
            options:{ responsive:true, maintainAspectRatio:false, plugins: { datalabels: { anchor: 'end', align: 'top', formatter: (v) => v.toLocaleString(), display: (ctx) => ctx.dataset.data[ctx.dataIndex] !== undefined } } }
        });
    }
    function changeRegion() { renderTable(); }
    window.onload = renderTable;
</script>
</body>
</html>





