<!DOCTYPE html>
<html lang="ja" class="notranslate">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">
    <title>実績管理ポータル</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        #pw_screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2d3748; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; }
        #pw_box { padding: 30px; background: white; border-radius: 12px; color: #333; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        input#pass_val { padding: 12px; font-size: 18px; border: 2px solid #ddd; border-radius: 6px; margin-bottom: 15px; width: 220px; text-align: center; }
        button.login-btn { padding: 12px 25px; background: #3182ce; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; }
        #main_content { display: none; }
        body { font-family: 'Hiragino Sans', sans-serif; background-color: #f0f4f8; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1750px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; overflow-x: auto; }
        .top-nav { background: #1a202c; padding: 15px 20px; color: white; display: flex; align-items: center; margin-bottom: 20px; border-radius: 0 0 12px 12px; }
        .nav-select { background: #2d3748; color: white; border: 1px solid #4a5568; padding: 8px 15px; border-radius: 6px; font-size: 1rem; margin-right: 15px; cursor: pointer; }
        h2 { font-size: 1.4rem; margin: 0; color: #1a202c; border-left: 5px solid #3182ce; padding-left: 15px; text-align: left; }
        
        table { width: 100%; border-collapse: collapse; background: white; border: 2px solid black !important; table-layout: fixed; }
        th, td { border: 1px solid black; padding: 6px 4px; text-align: right; font-size: 0.82rem; word-break: break-all; }
        th { background: #edf2f7; color: #4a5568; text-align: center; border-bottom: 2px solid black !important; }
        
        .cat-header { background: #ebf8ff; font-weight: bold; text-align: center; color: #2c5282; border-right: 2px solid black !important; border-bottom: 2px solid black !important; width: 130px; }
        .type-col { text-align: center; border-right: 2px solid black !important; width: 75px; }
        .month-sep { border-right: 2px solid black !important; }
        .second-half-start { border-left: 2px solid black !important; }
        .total-header { background: #edf2f7; color: #4a5568; text-align: center; font-weight: bold; border-left: 2px solid black !important; border-right: 2px solid black !important; }
        .total-col { background: #fffaf0; font-weight: bold; border-left: 2px solid black !important; border-right: 2px solid black !important; }
        .affiliation-header { background: #1a202c !important; color: white !important; text-align: left !important; padding: 10px 15px !important; font-size: 1rem !important; border-bottom: 2px solid black !important; }
        
        .item-bottom-bold td { border-bottom: 2px solid black !important; }
        .row-border td:not(.cat-header) { border-bottom: 1px solid #ddd !important; }

        .flex-stack-box { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; }
        .header-label-bold { font-weight: bold; font-size: 0.88rem; color: #1a202c; }
        .header-label-sub { font-size: 0.72rem; color: #666; font-weight: normal; }
        .data-value-std { font-weight: normal !important; font-size: 0.82rem !important; color: #333; }
        .tech-name-label { font-weight: bold; font-size: 0.9rem; }
        .tech-no-label { font-size: 0.7rem; color: #666; }

        .chart-box { height: 400px; width: 100%; margin-bottom: 20px; position: relative; }
        #loading { font-weight: bold; color: #3182ce; margin-top: 10px; }
    </style>
</head>
<body class="notranslate">
<div id="pw_screen">
    <div id="pw_box">
        <div style="font-size: 1.2rem; font-weight: bold; color: #2d3748; margin-bottom: 5px;">【実績管理】</div>
        <input type="password" id="pass_val" placeholder="パスワードを入力" onkeydown="if(event.keyCode==13)checkPW()">
        <br>
        <button class="login-btn" onclick="checkPW()">ログイン</button>
        <div id="loading" style="display:none;">データを取得中...</div>
        <p id="err_msg" style="color: red; display: none; margin-top:10px;">パスワードが違います</p>
    </div>
</div>
<div id="main_content">
    <div class="top-nav">
        <select id="year-select" class="nav-select" onchange="initApp()"></select>
        <select id="tool-select" class="nav-select" onchange="switchTool()">
            <option value="sales">営業実績・予算管理表</option>
            <option value="promotion">営業推進管理表</option>
            <option value="status">売込状況一覧</option>
        </select>
        <span id="sales-region-container" style="display:none;">
            <select id="region-select" class="nav-select" onchange="renderSalesTable()">
                <option value="total">全社</option>
                <option value="west">西日本</option>
                <option value="east">東日本</option>
                <option value="tokai">東海</option>
                <option value="tokyo">首都圏</option>
            </select>
        </span>
        <span id="promotion-filter-container" style="display:none;">
            <select id="promotion-region-select" class="nav-select" onchange="filterPromotion()">
                <option value="total">全社</option>
                <option value="西日本">西日本</option>
                <option value="東日本">東日本</option>
                <option value="東海">東海</option>
                <option value="首都圏">首都圏</option>
            </select>
        </span>
    </div>
    <div class="container">
        <div id="dashboard-sales" class="dashboard-view">
            <div class="card">
                <h2>営業実績・予算管理表</h2>
                <div style="margin-top:20px; overflow-x:auto;">
                    <table id="sales-table-main">
                        <thead>
                            <tr>
                                <th rowspan="2" class="cat-header">項目</th>
                                <th rowspan="2" class="type-col">区分</th>
                                <th colspan="6">上期実績</th><th class="total-header">上期計</th>
                                <th colspan="6" class="second-half-start">下期実績・予想</th><th class="total-header">下期合計</th>
                                <th class="total-header">年間合計</th>
                            </tr>
                            <tr>
                                <th>6月</th><th>7月</th><th>8月</th><th>9月</th><th>10月</th><th class="month-sep">11月</th><th class="total-header">計</th>
                                <th class="second-half-start">12月</th><th>1月</th><th>2月</th><th>3月</th><th>4月</th><th class="month-sep">5月</th><th class="total-header">計</th>
                                <th class="total-header">合計</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <h2>売上推移グラフ</h2>
                <div class="chart-box"><canvas id="salesChart"></canvas></div>
                <hr style="border:0; border-top:1px solid #eee; margin:40px 0;">
                <h2>稼働エンジニア数</h2>
                <div class="chart-box"><canvas id="engineerChart"></canvas></div>
                <hr style="border:0; border-top:1px solid #eee; margin:40px 0;">
                <h2>待機原価推移</h2>
                <div class="chart-box"><canvas id="waitingChart"></canvas></div>
            </div>
        </div>
        <div id="dashboard-generic" class="dashboard-view" style="display:none;">
            <div class="card">
                <h2 id="generic-title">管理表</h2>
                <div id="generic-content" style="margin-top:20px; overflow-x:auto;"></div>
            </div>
        </div>
    </div>
</div>
<script>
    Chart.register(ChartDataLabels);
    const YEAR_CONFIG = {
        '2025年6月期': {
            sales: { id: '1LRVwKu-YXWJvRgSophqF0VlORS5_dcjztSvfz95Qe_E', sheet: '実績データ' },
            promotion: { id: '1LRVwKu-YXWJvRgSophqF0VlORS5_dcjztSvfz95Qe_E', sheet: '営業推進管理表' },
            status: { id: '1LRVwKu-YXWJvRgSophqF0VlORS5_dcjztSvfz95Qe_E', sheet: '売込状況一覧' }
        }
    };
    let dataSet = { west: { budget:{}, actual:{} }, tokai: { budget:{}, actual:{} }, tokyo: { budget:{}, actual:{} } };
    let currentPromotionRows = [];
    let salesChart, waitingChart, engineerChart;
    const months = ["6月","7月","8月","9月","10月","11月","12月","1月","2月","3月","4月","5月"];

    window.onload = function() {
        const yrSelect = document.getElementById('year-select');
        Object.keys(YEAR_CONFIG).forEach(yr => {
            const opt = document.createElement('option');
            opt.value = yr; opt.innerText = yr; yrSelect.appendChild(opt);
        });
    };

    function checkPW() {
        if (document.getElementById('pass_val').value === "freeeks2022") initApp();
        else document.getElementById('err_msg').style.display = 'block';
    }

    function parseNum(val) {
        if (val === null || val === undefined || val === '') return 0;
        let s = String(val).replace(/,/g, '').replace(/[^-0-9.]/g, '');
        return Math.round(parseFloat(s)) || 0;
    }

    async function initApp() { await switchTool(); }

    async function switchTool() {
        const selectedYear = document.getElementById('year-select').value;
        const toolKey = document.getElementById('tool-select').value;
        const tool = YEAR_CONFIG[selectedYear][toolKey];
        document.getElementById('loading').style.display = 'block';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${tool.id}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tool.sheet)}`;
        try {
            const response = await fetch(CSV_URL);
            const csvText = await response.text();
            const rows = parseCSV(csvText);
            document.getElementById('pw_screen').style.display = 'none';
            document.getElementById('main_content').style.display = 'block';
            
            if (toolKey === 'sales') {
                document.getElementById('dashboard-sales').style.display = 'block';
                document.getElementById('dashboard-generic').style.display = 'none';
                document.getElementById('sales-region-container').style.display = 'inline-block';
                document.getElementById('promotion-filter-container').style.display = 'none';
                processSalesData(rows); renderSalesTable();
            } else {
                document.getElementById('dashboard-sales').style.display = 'none';
                document.getElementById('dashboard-generic').style.display = 'block';
                document.getElementById('sales-region-container').style.display = 'none';
                document.getElementById('promotion-filter-container').style.display = 'inline-block';
                document.getElementById('generic-title').innerText = toolKey === 'promotion' ? '営業推進管理表' : '売込状況一覧';
                currentPromotionRows = rows;
                filterPromotion();
            }
        } catch (e) { console.error(e); alert('取得失敗'); }
        finally { document.getElementById('loading').style.display = 'none'; }
    }

    function parseCSV(text) {
        return text.split(/\r?\n/).filter(line => line.trim() !== "").map(line => {
            const result = []; let current = '', inQuotes = false;
            for (let char of line) {
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                else current += char;
            }
            result.push(current.trim()); return result;
        });
    }

    function filterPromotion() {
        const region = document.getElementById('promotion-region-select').value;
        const toolKey = document.getElementById('tool-select').value;
        if (toolKey === 'promotion') renderPromotionTable(currentPromotionRows, region);
        else renderGenericTable(currentPromotionRows, region);
    }

    function fmtVal(v, type) {
        if (v === 0 || isNaN(v) || !isFinite(v)) return '-';
        if (type === 'num') return Math.round(v).toLocaleString();
        if (type === 'ratio') return (Math.floor(v * 100) / 100).toFixed(2);
        return v.toFixed(1) + '%';
    }

    function renderPromotionTable(rows, filterRegion) {
        if (rows.length < 2) return;
        const AffIndex = 2, NoIndex = 3, NameIndex = 4, SalaryIndex = 10, CostIndex = 11, DataStartCol = 12;
        let rawData = rows.slice(1).filter(r => r[NoIndex] && r[NoIndex].trim() !== "" && r[NoIndex] !== "技術者№");
        let data = (filterRegion === 'total') ? rawData : (filterRegion === '東日本' ? rawData.filter(r => r[AffIndex] === '東海' || r[AffIndex] === '首都圏') : rawData.filter(r => r[AffIndex] === filterRegion));
        
        let html = `<table><thead><tr><th rowspan="2" class="cat-header"><div class="flex-stack-box"><div class="header-label-bold">技術者名</div><div class="header-label-sub">スキルシートNO</div></div></th><th rowspan="2" class="cat-header"><div class="flex-stack-box"><div class="header-label-bold">給与</div><div class="header-label-bold">コスト</div></div></th><th rowspan="2" class="type-col">項目</th><th colspan="6">上期実績</th><th class="total-header">上期計</th><th colspan="6" class="second-half-start">下期実績・予想</th><th class="total-header">下期合計</th><th class="total-header">年間合計</th></tr><tr><th>6月</th><th>7月</th><th>8月</th><th>9月</th><th>10月</th><th class="month-sep">11月</th><th class="total-header">計</th><th class="second-half-start">12月</th><th>1月</th><th>2月</th><th>3月</th><th>4月</th><th class="month-sep">5月</th><th class="total-header">計</th><th class="total-header">合計</th></tr></thead><tbody>`;

        const overall = { sales: Array(12).fill(0), profit: Array(12).fill(0), margin: Array(12).fill(0), opRate: Array(12).fill(0), counts: Array(12).fill(0) };
        
        const techProcessed = data.map(m => {
            const isBP = (m[NoIndex] === 'BP 要員');
            const salVal = parseNum(m[SalaryIndex]);
            const costVal = parseNum(m[CostIndex]);
            const calcBaseForRate = isBP ? costVal : salVal;

            const sList = []; const cList = [];
            for(let i=0; i<12; i++) {
                sList.push(parseNum(m[DataStartCol + i * 2])); 
                cList.push(parseNum(m[DataStartCol + i * 2 + 1]));
            }
            
            const pList = sList.map((s, i) => s > 0 ? s - cList[i] : 0);
            const mList = sList.map((s, i) => s > 0 ? ((s - cList[i]) / s * 100) : 0);
            const oList = sList.map(s => (s > 0 && calcBaseForRate > 0) ? (s / calcBaseForRate) : 0);
            
            sList.forEach((s, i) => {
                if(s > 0) {
                    overall.sales[i] += s; overall.profit[i] += pList[i];
                    overall.margin[i] += mList[i]; overall.opRate[i] += oList[i];
                    overall.counts[i]++;
                }
            });
            return { name: m[NameIndex], no: m[NoIndex], aff: m[AffIndex], salVal, costVal, sList, pList, mList, oList };
        });

        // 全体合計行
        html += `<tr><td colspan="18" class="affiliation-header">全体合計 (${filterRegion==='total'?'全社':filterRegion})</td></tr>`;
        ['売上','利益','利益率','運用率'].forEach((label, idx) => {
            html += `<tr class="${idx === 3 ? 'item-bottom-bold' : 'row-border'}">`;
            if(idx === 0) html += `<td rowspan="4" colspan="2" class="cat-header" style="background:white; font-size:1rem;">全体合計</td>`;
            html += `<td class="metric-label">${label}</td>`;
            let h1Sum = 0, h1Cnt = 0, h2Sum = 0, h2Cnt = 0;
            for(let i=0; i<12; i++) {
                let v = 0, type = (idx === 0 || idx === 1) ? 'num' : (idx === 2 ? 'pct' : 'ratio');
                if (idx === 0) v = overall.sales[i];
                else if (idx === 1) v = overall.profit[i];
                else if (idx === 2) v = overall.counts[i] ? overall.margin[i] / overall.counts[i] : 0;
                else v = overall.counts[i] ? overall.opRate[i] / overall.counts[i] : 0;

                html += `<td class="${i===5||i===11?'month-sep':''} ${i===6?'second-half-start':''}">${fmtVal(v, type)}</td>`;
                if(v !== 0) { if(i < 6) { h1Sum += v; h1Cnt++; } else { h2Sum += v; h2Cnt++; } }
                if(i === 5) html += `<td class="total-col">${idx < 2 ? Math.round(h1Sum).toLocaleString() : (h1Cnt ? fmtVal(h1Sum / h1Cnt, type) : '-')}</td>`;
            }
            let h2D = idx < 2 ? Math.round(h2Sum).toLocaleString() : (h2Cnt ? fmtVal(h2Sum / h2Cnt, (idx===2?'pct':'ratio')) : '-');
            let yrD = idx < 2 ? Math.round(h1Sum + h2Sum).toLocaleString() : ((h1Cnt + h2Cnt) ? fmtVal((h1Sum + h2Sum) / (h1Cnt + h2Cnt), (idx===2?'pct':'ratio')) : '-');
            html += `<td class="total-col">${h2D}</td><td class="total-col">${yrD}</td></tr>`;
        });

        // 拠点別描画
        const affs = [...new Set(techProcessed.map(t => t.aff))];
        affs.forEach(aff => {
            html += `<tr><td colspan="18" class="affiliation-header">${aff}</td></tr>`;
            techProcessed.filter(t => t.aff === aff).forEach(t => {
                const metrics = [ { n:'売上', d:t.sList, t:'num' }, { n:'利益', d:t.pList, t:'num' }, { n:'利益率', d:t.mList, t:'pct' }, { n:'運用率', d:t.oList, t:'ratio' } ];
                metrics.forEach((met, idx) => {
                    html += `<tr class="${idx === 3 ? 'item-bottom-bold' : 'row-border'}">`;
                    if(idx === 0) {
                        html += `<td rowspan="4" class="cat-header" style="background:white; vertical-align:middle;"><div class="tech-info-box"><div class="tech-name-label">${t.name}</div><div class="tech-no-label">${t.no}</div></div></td>`;
                        html += `<td rowspan="4" class="cat-header" style="background:white; vertical-align:middle;"><div class="flex-stack-box"><div class="data-value-std">${t.salVal.toLocaleString()}</div><div class="data-value-std">${t.costVal.toLocaleString()}</div></div></td>`;
                    }
                    html += `<td class="metric-label">${met.n}</td>`;
                    let h1I = 0, h1C = 0, h2I = 0, h2C = 0;
                    met.d.forEach((v, i) => {
                        html += `<td class="${i===5||i===11?'month-sep':''} ${i===6?'second-half-start':''}">${fmtVal(v, met.t)}</td>`;
                        if(v !== 0) { if(i < 6) { h1I += v; h1C++; } else { h2I += v; h2C++; } }
                        if(i === 5) html += `<td class="total-col">${met.t === 'num' ? Math.round(h1I).toLocaleString() : (h1C ? fmtVal(h1I / h1C, met.t) : '-')}</td>`;
                    });
                    let h2DisplayVal = met.t === 'num' ? Math.round(h2I).toLocaleString() : (h2C ? fmtVal(h2I / h2C, met.t) : '-');
                    let yrDisplayVal = met.t === 'num' ? Math.round(h1I + h2I).toLocaleString() : ((h1C + h2C) ? fmtVal((h1I + h2I) / (h1C + h2C), met.t) : '-');
                    html += `<td class="total-col">${h2DisplayVal}</td><td class="total-col">${yrDisplayVal}</td></tr>`;
                });
            });
        });
        html += `</tbody></table>`;
        document.getElementById('generic-content').innerHTML = html;
    }

    function renderGenericTable(rows, filterRegion) {
        if (rows.length < 1) return;
        const AffIndex = 2;
        let data = rows.slice(1);
        if (filterRegion !== 'total') {
            data = (filterRegion === '東日本') ? data.filter(r => r[AffIndex] === '東海' || r[AffIndex] === '首都圏') : data.filter(r => r[AffIndex] === filterRegion);
        }
        let html = `<table><thead><tr>`;
        rows[0].forEach(h => html += `<th>${h}</th>`);
        html += `</tr></thead><tbody>`;
        data.forEach(row => { html += `<tr>`; row.forEach(cell => html += `<td>${cell || '-'}</td>`); html += `</tr>`; });
        html += `</tbody></table>`;
        document.getElementById('generic-content').innerHTML = html;
    }

    function renderSalesTable() {
        const rk = document.getElementById('region-select').value;
        const d = getRD(rk); const tb = document.getElementById('table-body');
        tb.innerHTML = "";
        const labels = [{l:'売上',c:'sales',r:['B','A','R']},{l:'稼働原価',c:'kCost',r:['B','A','R']},{l:'A利益',c:'aProfit',r:['B','A','R']},{l:'待機原価',c:'waitCost',r:['A']},{l:'プロパー(稼働)',c:'propK',r:['B','A','R']},{l:'BP',c:'bpK',r:['A']},{l:'稼働エンジニア数',c:'workEngTotal',r:['B','A']},{l:'エンジニア総数',c:'totalEng',r:['B','A','R']},{l:'プロパー(待機)',c:'propW',r:['B','A']},{l:'待機率',c:'waitRate',r:['A']}];
        labels.forEach(item => {
            const hasB=item.r.includes('B'), hasA=item.r.includes('A'), hasR=item.r.includes('R'), rCnt=item.r.length;
            let rB=`<tr class="row-border"><td rowspan="${rCnt}" class="cat-header">${item.l}</td><td class="type-col">予算</td>`, rA=`<tr class="${!hasR?'item-bottom-bold':'row-border'}"><td class="type-col">実績</td>`, rR=`<tr class="item-bottom-bold"><td class="type-col">達成率</td>`;
            if(!hasB) rA = `<tr class="item-bottom-bold"><td rowspan="${rCnt}" class="cat-header">${item.l}</td><td class="type-col">実績</td>`;
            let b1=0, b2=0, a1=0, a2=0;
            for(let i=0; i<12; i++){
                let bV=d.budget[item.c]?.[i]||0, aV=d.actual[item.c]?.[i]||0;
                if(i<6){b1+=bV; a1+=aV;}else{b2+=bV; a2+=aV;}
                const cls=`${i===5||i===11?'month-sep':''} ${i===6?'second-half-start':''}`;
                if(hasB) rB+=`<td class="${cls}">${bV?Math.round(bV).toLocaleString():'-'}</td>`;
                if(hasA) rA+=`<td class="${cls}">${d.actual[item.c]?.[i]!==null?(item.c==='waitRate'?d.actual[item.c][i].toFixed(1)+'%':Math.round(d.actual[item.c][i]).toLocaleString()):'-'}</td>`;
                if(hasR) rR+=`<td class="${cls}">${(d.actual[item.c]?.[i]!==null&&bV)?(d.actual[item.c][i]/bV*100).toFixed(1)+'%':'-'}</td>`;
                if(i===5){
                    if(hasB) rB+=`<td class="total-col">${Math.round(b1).toLocaleString()}</td>`;
                    if(hasA) rA+=`<td class="total-col">${Math.round(a1).toLocaleString()}</td>`;
                    if(hasR) rR+=`<td class="total-col">${b1?(a1/b1*100).toFixed(1)+'%':'-'}</td>`;
                }
            }
            if(hasB) rB+=`<td class="total-col">${Math.round(b2).toLocaleString()}</td><td class="total-col">${Math.round(b1+b2).toLocaleString()}</td></tr>`;
            if(hasA) rA+=`<td class="total-col">${Math.round(a2).toLocaleString()}</td><td class="total-col">${Math.round(a1+a2).toLocaleString()}</td></tr>`;
            if(hasR) rR+=`<td class="total-col">${b2?(a2/b2*100).toFixed(1)+'%':'-'}</td><td class="total-col">${(b1+b2)?((a1+a2)/(b1+b2)*100).toFixed(1)+'%':'-'}</td></tr>`;
            tb.innerHTML += (hasB?rB:'')+rA+(hasR?rR:'');
        });
        drawSalesCharts(d);
    }

    function drawSalesCharts(d) {
        const opt = { responsive:true, maintainAspectRatio:false, plugins:{datalabels:{anchor:'end',align:'top',formatter:v=>v?v.toLocaleString():''}} };
        if(salesChart) salesChart.destroy();
        salesChart = new Chart(document.getElementById('salesChart'), { type:'bar', data:{ labels:months, datasets:[{label:'予算',data:d.budget.sales,backgroundColor:'#cbd5e0'},{label:'実績',data:d.actual.sales.map((v,i)=>i<9?v:undefined),backgroundColor:'#3182ce'}] }, options:opt });
        if(engineerChart) engineerChart.destroy();
        engineerChart = new Chart(document.getElementById('engineerChart'), { type:'bar', data:{ labels:months, datasets:[{label:'プロパー',data:d.actual.propK.map((v,i)=>i<9?v:undefined),backgroundColor:'#10b981'},{label:'BP',data:d.actual.bpK.map((v,i)=>i<9?v:undefined),backgroundColor:'#8b5cf6'}] }, options:{...opt, scales:{x:{stacked:true},y:{stacked:true}}, plugins:{datalabels:{color:'#fff'}}} });
        if(waitingChart) waitingChart.destroy();
        waitingChart = new Chart(document.getElementById('waitingChart'), { type:'bar', data:{ labels:months, datasets:[{label:'待機原価',data:d.actual.waitCost.map((v,i)=>i<9?v:undefined),backgroundColor:'#e53e3e'}] }, options:opt });
    }

    function processSalesData(rows) {
        dataSet = { west: { budget:{}, actual:{} }, tokai: { budget:{}, actual:{} }, tokyo: { budget:{}, actual:{} } };
        const regMap = {'西日本':'west','東海':'tokai','首都圏':'tokyo'}, lblMap = {'売上':'sales','稼働原価':'kCost','A利益':'aProfit','待機原価':'waitCost','プロパー(稼働)':'propK','BP':'bpK','稼働エンジニア総数':'workEngTotal','エンジニア総数':'totalEng','プロパー(待機)':'propW','待機率':'waitRate'};
        rows.slice(1).forEach(row => {
            const rK = regMap[row[0]], lK = lblMap[row[1]], type = row[2] === '予算' ? 'budget' : 'actual';
            if(rK && lK) {
                if(!dataSet[rK][type][lK]) dataSet[rK][type][lK] = Array(12).fill(null);
                for(let i=3; i<15; i++) {
                    let v = row[i] ? row[i].replace(/,/g, '').replace('%', '') : null;
                    dataSet[rK][type][lK][i-3] = (v===null||v===""||isNaN(v))?null:parseFloat(v);
                }
            }
        });
    }

    function getRD(k) {
        let rs = k==='total'?['west','tokai','tokyo']:(k==='east'?['tokai','tokyo']:[k]);
        const res = { budget:{}, actual:{} }, lbls = ['sales','kCost','aProfit','waitCost','propK','bpK','workEngTotal','totalEng','propW','waitRate'];
        lbls.forEach(c => {
            res.budget[c] = Array(12).fill(0).map((_,i)=>rs.reduce((s,r)=>s+(dataSet[r].budget[c]?.[i]||0),0));
            res.actual[c] = Array(12).fill(null).map((_,i)=>{
                let h=false, s=0; rs.forEach(r=>{if(dataSet[r].actual[c]?.[i]!==null){h=true; s+=dataSet[r].actual[c][i];}});
                return h?s:null;
            });
        });
        return res;
    }
</script>
</body>
</html>




