<!DOCTYPE html>
<html lang="ja" class="notranslate">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">
    <title>実績管理ポータル</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        #pw_screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2d3748; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; }
        #pw_box { padding: 30px; background: white; border-radius: 12px; color: #333; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        input#pass_val { padding: 12px; font-size: 18px; border: 2px solid #ddd; border-radius: 6px; margin-bottom: 15px; width: 220px; text-align: center; }
        button.login-btn { padding: 12px 25px; background: #3182ce; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; }
        #main_content { display: none; }
        body { font-family: 'Hiragino Sans', sans-serif; background-color: #f0f4f8; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1750px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; overflow-x: auto; }
        .top-nav { background: #1a202c; padding: 15px 20px; color: white; display: flex; align-items: center; margin-bottom: 20px; border-radius: 0 0 12px 12px; }
        .nav-select { background: #2d3748; color: white; border: 1px solid #4a5568; padding: 8px 15px; border-radius: 6px; font-size: 1rem; margin-right: 15px; cursor: pointer; }
        h2 { font-size: 1.4rem; margin: 0; color: #1a202c; border-left: 5px solid #3182ce; padding-left: 15px; text-align: left; }
        
        /* 表全体の枠線とセルの境界線設定 */
        table { width: 100%; border-collapse: collapse; background: white; border: 2px solid black !important; table-layout: fixed; }
        th, td { border: 1px solid black !important; padding: 8px 6px; text-align: center; font-size: 0.85rem; word-break: break-all; }
        th { background: #edf2f7; color: #4a5568; border-bottom: 2px solid black !important; }
        
        .cat-header { background: #ebf8ff; font-weight: bold; text-align: center; color: #2c5282; border-right: 2px solid black !important; border-bottom: 2px solid black !important; width: 130px; }
        .type-col { text-align: center; border-right: 2px solid black !important; width: 75px; }
        .month-sep { border-right: 2px solid black !important; }
        .second-half-start { border-left: 2px solid black !important; }
        .total-header { background: #edf2f7; color: #4a5568; text-align: center; font-weight: bold; border-left: 2px solid black !important; border-right: 2px solid black !important; }
        .total-col { background: #fffaf0; font-weight: bold; border-left: 2px solid black !important; border-right: 2px solid black !important; }
        .affiliation-header { background: #1a202c !important; color: white !important; text-align: left !important; padding: 10px 15px !important; font-size: 1rem !important; border-bottom: 2px solid black !important; }
        
        /* 項目ごとの区切り太線設定 */
        .item-bottom-bold td { border-bottom: 3px solid black !important; }
        .row-border td:not(.cat-header) { border-bottom: 1px solid black !important; }

        .cell-main-text { font-weight: bold; font-size: 0.95rem; color: #1a202c; }
        .cell-sub-text { font-size: 0.75rem; color: #666; margin-top: 2px; }
        .border-bottom-bold { border-bottom: 2px solid black !important; }
        
        .col-name { width: 250px; }
        .col-reason { width: auto; }
        .col-date { width: 250px; }

        .chart-box { height: 400px; width: 100%; margin-bottom: 20px; position: relative; }
        #loading { font-weight: bold; color: #3182ce; margin-top: 10px; }
    </style>
</head>
<body class="notranslate">
<div id="pw_screen">
    <div id="pw_box">
        <div style="font-size: 1.2rem; font-weight: bold; color: #2d3748; margin-bottom: 5px;">【実績管理】</div>
        <input type="password" id="pass_val" placeholder="パスワードを入力" onkeydown="if(event.keyCode==13)checkPW()">
        <br>
        <button class="login-btn" onclick="checkPW()">ログイン</button>
        <div id="loading" style="display:none;">データを取得中...</div>
        <p id="err_msg" style="color: red; display: none; margin-top:10px;">パスワードが違います</p>
    </div>
</div>
<div id="main_content">
    <div class="top-nav">
        <select id="year-select" class="nav-select" onchange="initApp()"></select>
        <select id="tool-select" class="nav-select" onchange="switchTool()">
            <option value="sales">営業実績・予算管理表</option>
            <option value="promotion">営業推進管理表</option>
            <option value="status">売込状況一覧</option>
        </select>
        <span id="sales-region-container" style="display:none;">
            <select id="region-select" class="nav-select" onchange="renderSalesTable()">
                <option value="total">全社</option>
                <option value="west">西日本</option>
                <option value="east">東日本</option>
                <option value="tokai">東海</option>
                <option value="tokyo">首都圏</option>
            </select>
        </span>
        <span id="promotion-filter-container" style="display:none;">
            <select id="promotion-region-select" class="nav-select" onchange="filterPromotion()">
                <option value="total">全社</option>
                <option value="西日本">西日本</option>
                <option value="東日本">東日本</option>
                <option value="東海">東海</option>
                <option value="首都圏">首都圏</option>
            </select>
        </span>
    </div>
    <div class="container">
        <div id="dashboard-sales" class="dashboard-view">
            <div class="card">
                <h2>営業実績・予算管理表</h2>
                <div style="margin-top:20px; overflow-x:auto;">
                    <table id="sales-table-main">
                        <thead>
                            <tr>
                                <th rowspan="2" class="cat-header">項目</th>
                                <th rowspan="2" class="type-col">区分</th>
                                <th colspan="6">上期実績</th><th class="total-header">上期計</th>
                                <th colspan="6" class="second-half-start">下期実績・予想</th><th class="total-header">下期合計</th>
                                <th class="total-header">年間合計</th>
                            </tr>
                            <tr>
                                <th>6月</th><th>7月</th><th>8月</th><th>9月</th><th>10月</th><th class="month-sep">11月</th><th class="total-header">計</th>
                                <th class="second-half-start">12月</th><th>1月</th><th>2月</th><th>3月</th><th>4月</th><th class="month-sep">5月</th><th class="total-header">計</th>
                                <th class="total-header">合計</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <h2>売上推移グラフ</h2>
                <div class="chart-box"><canvas id="salesChart"></canvas></div>
                <hr style="border:0; border-top:1px solid #eee; margin:40px 0;">
                <h2>稼働エンジニア数</h2>
                <div class="chart-box"><canvas id="engineerChart"></canvas></div>
                <hr style="border:0; border-top:1px solid #eee; margin:40px 0;">
                <h2>待機原価推移</h2>
                <div class="chart-box"><canvas id="waitingChart"></canvas></div>
            </div>
        </div>
        <div id="dashboard-generic" class="dashboard-view" style="display:none;">
            <div class="card">
                <h2 id="generic-title">管理表</h2>
                <div id="generic-content" style="margin-top:20px; overflow-x:auto;"></div>
            </div>
        </div>
    </div>
</div>
<script>
    Chart.register(ChartDataLabels);
    const YEAR_CONFIG = {
        '2025年6月期': {
            sales: { id: '1LRVwKu-YXWJvRgSophqF0VlORS5_dcjztSvfz95Qe_E', sheet: '実績データ' },
            promotion: { id: '1LRVwKu-YXWJvRgSophqF0VlORS5_dcjztSvfz95Qe_E', sheet: '営業推進管理表' },
            status: { id: '1LRVwKu-YXWJvRgSophqF0VlORS5_dcjztSvfz95Qe_E', sheet: '売込状況一覧' }
        }
    };
    let dataSet = { west: { budget:{}, actual:{} }, tokai: { budget:{}, actual:{} }, tokyo: { budget:{}, actual:{} } };
    let currentDataRows = [];
    let salesChart, waitingChart, engineerChart;
    const months = ["6月","7月","8月","9月","10月","11月","12月","1月","2月","3月","4月","5月"];

    window.onload = function() {
        const yrSelect = document.getElementById('year-select');
        Object.keys(YEAR_CONFIG).forEach(yr => {
            const opt = document.createElement('option');
            opt.value = yr; opt.innerText = yr; yrSelect.appendChild(opt);
        });
    };

    function checkPW() {
        if (document.getElementById('pass_val').value === "freeeks2022") initApp();
        else document.getElementById('err_msg').style.display = 'block';
    }

    function parseNum(val) {
        if (val === null || val === undefined || val === '') return 0;
        let s = String(val).replace(/,/g, '').replace(/[^-0-9.]/g, '');
        return Math.round(parseFloat(s)) || 0;
    }

    async function initApp() { await switchTool(); }

    async function switchTool() {
        const selectedYear = document.getElementById('year-select').value;
        const toolKey = document.getElementById('tool-select').value;
        const tool = YEAR_CONFIG[selectedYear][toolKey];
        document.getElementById('loading').style.display = 'block';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${tool.id}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tool.sheet)}`;
        try {
            const response = await fetch(CSV_URL);
            const csvText = await response.text();
            const rows = parseCSV(csvText);
            document.getElementById('pw_screen').style.display = 'none';
            document.getElementById('main_content').style.display = 'block';
            if (toolKey === 'sales') {
                document.getElementById('dashboard-sales').style.display = 'block';
                document.getElementById('dashboard-generic').style.display = 'none';
                document.getElementById('sales-region-container').style.display = 'inline-block';
                document.getElementById('promotion-filter-container').style.display = 'none';
                processSalesData(rows); renderSalesTable();
            } else {
                document.getElementById('dashboard-sales').style.display = 'none';
                document.getElementById('dashboard-generic').style.display = 'block';



