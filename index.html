<!DOCTYPE html>
<html lang="ja" class="notranslate">
<head>
    <meta charset="UTF-8">
    <title>実績管理ポータル</title>
    <style>
        body { font-family: 'Hiragino Sans', sans-serif; background-color: #f0f4f8; padding: 20px; color: #333; }
        #pw_screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a202c; display: flex; justify-content: center; align-items: center; z-index: 10000; }
        #main_content { display: none; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow-x: auto; }
        
        /* --- 全ての枠線を3pxの太線に設定 --- */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            background: white; 
            border: 3px solid black !important; 
            table-layout: fixed; 
        }
        th, td { 
            border: 3px solid black !important; 
            padding: 8px 4px; 
            font-size: 0.85rem; 
            word-break: break-all; 
        }
        th { 
            background: #edf2f7; 
            text-align: center; 
        }
        
        /* --- 特定箇所の境界線(実績と達成率の間)を2pxに変更 --- */
        .border-bottom-2px td {
            border-bottom: 2px solid black !important;
        }

        .cat-header { background: #ebf8ff; font-weight: bold; width: 130px; text-align: center !important; }
        .type-col { width: 70px; text-align: center !important; }
        .total-col { background: #fffaf0; font-weight: bold; }
        
        /* 文字の配置設定 */
        .text-right { text-align: right !important; padding-right: 8px !important; }
        .text-center { text-align: center !important; }
        
        #loading { font-weight: bold; color: #3182ce; margin-bottom: 10px; }
    </style>
</head>
<body class="notranslate">

<div id="pw_screen">
    <div style="background:white; color:black; padding:40px; border-radius:12px; text-align:center; box-shadow: 0 10px 25px rgba(0,0,0,0.5);">
        <h2 style="margin-top:0;">実績管理ログイン</h2>
        <input type="password" id="pass_val" style="padding:12px; font-size:18px; border:2px solid #ddd; border-radius:6px; width:220px;" onkeydown="if(event.keyCode==13)checkPW()">
        <br><br>
        <button onclick="checkPW()" style="padding:12px 35px; background:#3182ce; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; font-size:16px;">ログイン</button>
        <p id="err_msg" style="color:red; display:none; margin-top:10px;">パスワードが違います</p>
    </div>
</div>

<div id="main_content">
    <div class="card">
        <div style="display:flex; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; border-left:5px solid #3182ce; padding-left:15px; margin-right: 25px;">営業実績・予算管理表</h2>
            <select id="region-select" style="padding:8px 15px; border-radius:6px; font-size:1rem; cursor:pointer;" onchange="renderTable()">
                <option value="全体合計">全体合計</option>
                <option value="東海">東海</option>
                <option value="首都圏">首都圏</option>
                <option value="東日本">東日本</option>
                <option value="西日本">西日本</option>
            </select>
        </div>
        <div id="loading" style="display:none;">データ読み込み中...</div>
        <table id="sales-table">
            <thead>
                <tr>
                    <th rowspan="2" class="cat-header">項目</th>
                    <th rowspan="2" class="type-col">区分</th>
                    <th colspan="6">上期実績</th><th class="total-col">上期計</th>
                    <th colspan="6">下期実績・予想</th><th class="total-col">下期計</th>
                    <th class="total-col">年間計</th>
                </tr>
                <tr>
                    <th>6月</th><th>7月</th><th>8月</th><th>9月</th><th>10月</th><th>11月</th><th class="total-col">計</th>
                    <th>12月</th><th>1月</th><th>2月</th><th>3月</th><th>4月</th><th>5月</th><th class="total-col">計</th>
                    <th class="total-col">合計</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<script>
    const SHEET_ID = '1LRVwKu-YXWJvRgSophqF0VlORS5_dcjztSvfz95Qe_E';
    let rawRows = [];

    function checkPW() {
        if (document.getElementById('pass_val').value === "freeeks2022") {
            document.getElementById('pw_screen').style.display = 'none';
            document.getElementById('main_content').style.display = 'block';
            fetchData();
        } else {
            document.getElementById('err_msg').style.display = 'block';
        }
    }

    async function fetchData() {
        document.getElementById('loading').style.display = 'block';
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent('実績データ')}`;
        try {
            const response = await fetch(url);
            const text = await response.text();
            rawRows = parseCSV(text);
            renderTable();
        } catch (e) {
            alert('取得失敗');
            console.error(e);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function parseCSV(t) {
        return t.split(/\r?\n/).filter(l => l.trim() !== "").map(l => {
            const res = []; let cur = '', q = false;
            for (let ch of l) {
                if (ch === '"') q = !q;
                else if (ch === ',' && !q) { res.push(cur.trim()); cur = ''; }
                else cur += ch;
            }
            res.push(cur.trim()); return res;
        });
    }

    function renderTable() {
        const region = document.getElementById('region-select').value;
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';

        const items = [
            { n: '売上', k: '売上', t: ['予算', '実績', '達成率'] },
            { n: '稼働原価', k: '稼働原価', t: ['予算', '実績', '達成率'] },
            { n: 'A利益', k: 'A利益', t: ['予算', '実績', '達成率'] },
            { n: '待機原価', k: '待機原価', t: ['実績'] },
            { n: 'プロパー(稼働)', k: 'プロパー(稼働)', t: ['予算', '実績', '達成率'] },
            { n: 'BP', k: 'BP', t: ['実績'] },
            { n: '稼働エンジニア数', k: '稼働エンジニア数', t: ['予算', '実績'] },
            { n: 'プロパー(待機)', k: 'プロパー(待機)', t: ['予算', '実績'] },
            { n: '待機率', k: '待機率', t: ['実績'] },
            { n: 'エンジニア総数', k: 'エンジニア総数', t: ['予算', '実績', '達成率'] }
        ];

        const border2pxItems = ['売上', '稼働原価', 'A利益', 'プロパー(稼働)', 'エンジニア総数'];

        items.forEach(item => {
            item.t.forEach((type, idx) => {
                const tr = document.createElement('tr');
                if (border2pxItems.includes(item.n) && type === '実績') {
                    tr.className = 'border-bottom-2px';
                }

                let html = idx === 0 ? `<td rowspan="${item.t.length}" class="cat-header">${item.n}</td>` : '';
                html += `<td class="type-col">${type}</td>`;

                const data = getMonthlyValues(region, item.k, type);
                let h1Sum = null;
                let h2Sum = null;

                data.forEach((v, i) => {
                    const displayVal = formatVal(v, item.k, type);
                    const alignCls = displayVal === '-' ? 'text-center' : 'text-right';
                    html += `<td class="${alignCls}">${displayVal}</td>`;
                    if (v !== null) {
                        if (i < 6) h1Sum = (h1Sum || 0) + v;
                        else h2Sum = (h2Sum || 0) + v;
                    }
                    if (i === 5) {
                        const h1Display = formatVal(h1Sum, item.k, type);
                        const h1Align = h1Display === '-' ? 'text-center' : 'text-right';
                        html += `<td class="total-col ${h1Align}">${h1Display}</td>`;
                    }
                });

                const h2Display = formatVal(h2Sum, item.k, type);
                const h2Align = h2Display === '-' ? 'text-center' : 'text-right';
                html += `<td class="total-col ${h2Align}">${h2Display}</td>`;

                const totalVal = (h1Sum === null && h2Sum === null) ? null : (h1Sum || 0) + (h2Sum || 0);
                const totalDisplay = formatVal(totalVal, item.k, type);
                const totalAlign = totalDisplay === '-' ? 'text-center' : 'text-right';
                html += `<td class="total-col ${totalAlign}">${totalDisplay}</td>`;

                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        });
    }

    function getMonthlyValues(region, itemK, type) {
        if (itemK === '稼働エンジニア数') {
            if (type === '予算') return getMonthlyValues(region, 'プロパー(稼働)', '予算');
            if (type === '実績') {
                const prop = getMonthlyValues(region, 'プロパー(稼働)', '実績');
                const bp = getMonthlyValues(region, 'BP', '実績');
                return prop.map((v, i) => (v === null && bp[i] === null) ? null : (v || 0) + (bp[i] || 0));
            }
        }

        let res = new Array(12).fill(null);
        if (type === '達成率') {
            const b = getMonthlyValues(region, itemK, '予算');
            const a = getMonthlyValues(region, itemK, '実績');
            return a.map((v, i) => (b[i] === null || a[i] === null) ? null : (b[i] === 0 ? 0 : (v / b[i]) * 100));
        }

        rawRows.slice(1).forEach(r => {
            const rowRegion = (r[0] || '').trim();
            const rowItem = (r[1] || '').trim();
            const rowType = (r[2] || '').trim();
            let isMatch = (region === '全体合計') ? true : (rowRegion === region);
            if (isMatch && rowItem.includes(itemK) && rowType.includes(type)) {
                for (let i = 0; i < 12; i++) {
                    let val = r[i+3];
                    if (val !== undefined && val !== "") {
                        if (res[i] === null) res[i] = 0;
                        res[i] += parseFloat(String(val).replace(/,/g,'').replace(/"/g, '')) || 0;
                    }
                }
            }
        });
        return res;
    }

    function formatVal(v, k, t) {
        if (v === null) return '-';
        if (k === '待機率' || t === '達成率') return v.toFixed(1) + '%';
        return Math.round(v).toLocaleString();
    }
</script>
</body>
</html>



