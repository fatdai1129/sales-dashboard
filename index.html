<!DOCTYPE html>
<html lang="ja" class="notranslate">
<head>
    <meta charset="UTF-8">
    <title>実績管理ポータル</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Hiragino Sans', sans-serif; background-color: #f0f4f8; padding: 20px; color: #333; }
        #pw_screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a202c; display: flex; justify-content: center; align-items: center; z-index: 10000; }
        #pw_box { background: white; padding: 40px; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        #main_content { display: none; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow-x: auto; margin-bottom: 25px; }
        
        /* --- 枠線：固定（一切の変更禁止） --- */
        table { width: 100%; border-collapse: collapse; background: white; border: 4px solid black !important; table-layout: fixed; }
        th, td { border-top: 1px solid black; border-bottom: 1px solid black; border-left: 4px solid black !important; border-right: 4px solid black !important; padding: 8px 4px; font-size: 0.85rem; word-break: break-all; }
        th { background: #edf2f7; text-align: center; border-bottom: 4px solid black !important; }
        .cat-header { border: 4px solid black !important; background: #ebf8ff; font-weight: bold; width: 130px; text-align: center !important; }
        .type-col { width: 70px; text-align: center !important; }
        .total-col { background: #fffaf0; font-weight: bold; }
        tr.bb-4px td { border-bottom: 4px solid black !important; } 
        tr.bb-3px td { border-bottom: 3px solid black !important; }
        .text-right { text-align: right !important; padding-right: 8px !important; }
        .text-center { text-align: center !important; }
        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 350px; }
    </style>
</head>
<body class="notranslate">

<div id="pw_screen">
    <div id="pw_box">
        <h2 style="margin-top:0;">実績管理ログイン</h2>
        <input type="password" id="pass_val" style="padding:12px; font-size:18px; border:2px solid #ddd; border-radius:6px; width:220px;" onkeydown="if(event.keyCode==13)checkPW()">
        <br><br>
        <button onclick="checkPW()" style="padding:12px 35px; background:#3182ce; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; font-size:16px;">ログイン</button>
        <p id="err_msg" style="color:red; display:none; margin-top:10px;">パスワードが違います</p>
    </div>
</div>

<div id="main_content">
    <div class="card">
        <div style="display:flex; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; border-left:5px solid #3182ce; padding-left:15px; margin-right: 25px;">営業実績・予算管理表</h2>
            <select id="region-select" style="padding:8px 15px; border-radius:6px; font-size:1rem; cursor:pointer;" onchange="renderAll()">
                <option value="全体合計">全体合計</option>
                <option value="東海">東海</option>
                <option value="首都圏">首都圏</option>
                <option value="東日本">東日本</option>
                <option value="西日本">西日本</option>
            </select>
        </div>
        <div id="loading" style="display:none; font-weight:bold; color:#3182ce;">データ読み込み中...</div>
        <table id="sales-table">
            <thead>
                <tr>
                    <th rowspan="2" class="cat-header">項目</th>
                    <th rowspan="2" class="type-col">区分</th>
                    <th colspan="6">上期実績</th><th class="total-col">上期計</th>
                    <th colspan="6" style="border-left:4px solid black !important;">下期実績・予想</th><th class="total-col">下期計</th>
                    <th class="total-col">年間計</th>
                </tr>
                <tr>
                    <th>6月</th><th>7月</th><th>8月</th><th>9月</th><th>10月</th><th style="border-right:4px solid black !important;">11月</th><th class="total-col">計</th>
                    <th style="border-left:4px solid black !important;">12月</th><th>1月</th><th>2月</th><th>3月</th><th>4月</th><th style="border-right:4px solid black !important;">5月</th><th class="total-col">計</th>
                    <th class="total-col">合計</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <div class="charts-container">
        <div class="chart-box"><canvas id="salesChart"></canvas></div>
        <div class="chart-box"><canvas id="engChart"></canvas></div>
        <div class="chart-box"><canvas id="waitCostChart"></canvas></div>
    </div>
</div>

<script>
    // --- 最新のGAS URLに更新 ---
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzLPhdnyAo1D7SH-T3uv0EOb5aWekcfnFRtReGhsnkQ5_sLbi36fTc6o5eVYukeliVJIA/exec';
    let rawRows = [];
    let charts = {};

    function checkPW() {
        if (document.getElementById('pass_val').value === "freeeks2022") {
            document.getElementById('pw_screen').style.display = 'none';
            document.getElementById('main_content').style.display = 'block';
            fetchData();
        } else {
            document.getElementById('err_msg').style.display = 'block';
        }
    }

    async function fetchData() {
        document.getElementById('loading').style.display = 'block';
        const url = `${GAS_URL}?p=freeeks2022`;
        try {
            const response = await fetch(url);
            rawRows = await response.json();
            renderAll();
        } catch (e) {
            alert('データ連携に失敗しました。GASの公開設定を確認してください。');
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function renderAll() {
        renderTable();
        updateCharts();
    }

    function renderTable() {
        const region = document.getElementById('region-select').value;
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';

        const items = [
            { n: '売上', k: '売上', t: ['予算', '実績', '達成率'] },
            { n: '稼働原価', k: '稼働原価', t: ['予算', '実績', '達成率'] },
            { n: 'A利益', k: 'A利益', t: ['予算', '実績', '達成率'] },
            { n: '待機原価', k: '待機原価', t: ['実績'] },
            { n: 'プロパー(稼働)', k: 'プロパー(稼働)', t: ['予算', '実績', '達成率'] },
            { n: 'BP', k: 'BP', t: ['実績'] },
            { n: '稼働エンジニア数', k: '稼働エンジニア数', t: ['予算', '実績'] },
            { n: 'プロパー(待機)', k: 'プロパー(待機)', t: ['予算', '実績'] },
            { n: '待機率', k: '待機率', t: ['実績'] },
            { n: 'エンジニア総数', k: 'エンジニア総数', t: ['予算', '実績', '達成率'] }
        ];

        const target3px = ['売上', '稼働原価', 'A利益', 'プロパー(稼働)', 'エンジニア総数'];

        items.forEach(item => {
            item.t.forEach((type, idx) => {
                const tr = document.createElement('tr');
                if (idx === item.t.length - 1) {
                    tr.className = 'bb-4px'; 
                } else if (target3px.includes(item.n) && type === '実績') {
                    tr.className = 'bb-3px'; 
                }

                let html = idx === 0 ? `<td rowspan="${item.t.length}" class="cat-header">${item.n}</td>` : '';
                html += `<td class="type-col">${type}</td>`;

                const data = getMonthlyValues(region, item.k, type);
                let h1Sum = null; let h2Sum = null;

                data.forEach((v, i) => {
                    const disp = formatVal(v, item.k, type);
                    const align = disp === '-' ? 'text-center' : 'text-right';
                    const borderR = (i === 5 || i === 11) ? 'style="border-right:4px solid black !important;"' : '';
                    const borderL = (i === 6) ? 'style="border-left:4px solid black !important;"' : '';
                    html += `<td class="${align}" ${borderR} ${borderL}>${disp}</td>`;
                    if (v !== null) {
                        if (i < 6) h1Sum = (h1Sum || 0) + v;
                        else h2Sum = (h2Sum || 0) + v;
                    }
                    if (i === 5) {
                        const h1Disp = formatVal(h1Sum, item.k, type);
                        html += `<td class="total-col ${h1Disp === '-' ? 'text-center' : 'text-right'}">${h1Disp}</td>`;
                    }
                });

                const h2Disp = formatVal(h2Sum, item.k, type);
                html += `<td class="total-col ${h2Disp === '-' ? 'text-center' : 'text-right'}">${h2Disp}</td>`;
                const totalVal = (h1Sum === null && h2Sum === null) ? null : (h1Sum || 0) + (h2Sum || 0);
                const totalDisp = formatVal(totalVal, item.k, type);
                html += `<td class="total-col ${totalDisp === '-' ? 'text-center' : 'text-right'}">${totalDisp}</td>`;

                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        });
    }

    function getMonthlyValues(region, itemK, type) {
        if (itemK === '稼働エンジニア数') {
            if (type === '予算') return getMonthlyValues(region, 'プロパー(稼働)', '予算');
            if (type === '実績') {
                const p = getMonthlyValues(region, 'プロパー(稼働)', '実績');
                const b = getMonthlyValues(region, 'BP', '実績');
                return p.map((v, i) => (v === null && b[i] === null) ? null : (v || 0) + (b[i] || 0));
            }
        }
        if (itemK === 'エンジニア総数') {
            const working = getMonthlyValues(region, '稼働エンジニア数', type);
            const waiting = getMonthlyValues(region, 'プロパー(待機)', type);
            return working.map((v, i) => (v === null && waiting[i] === null) ? null : (v || 0) + (waiting[i] || 0));
        }

        let res = new Array(12).fill(null);
        if (type === '達成率') {
            const bud = getMonthlyValues(region, itemK, '予算');
            const act = getMonthlyValues(region, itemK, '実績');
            return act.map((v, i) => (bud[i] === null || act[i] === null) ? null : (bud[i] === 0 ? 0 : (v / bud[i]) * 100));
        }

        rawRows.slice(1).forEach(r => {
            const rN = (r[0] || '').trim();
            const iN = (r[1] || '').trim();
            const tN = (r[2] || '').trim();
            
            // 全体合計の時は二重計上を防ぐため、元の3拠点のみを足す
            let match = false;
            if (region === '全体合計') {
                if (rN === '東海' || rN === '首都圏' || rN === '西日本') match = true;
            } else {
                if (rN === region) match = true;
            }

            if (match && iN === itemK && tN === type) {
                for (let i = 0; i < 12; i++) {
                    let cellVal = r[i+3];
                    if (cellVal !== undefined && cellVal !== "") {
                        if (res[i] === null) res[i] = 0;
                        res[i] += parseFloat(String(cellVal).replace(/,/g,'')) || 0;
                    }
                }
            }
        });
        return res;
    }

    function formatVal(v, k, t) {
        if (v === null) return '-';
        if (k === '待機率' || t === '達成率') return v.toFixed(1) + '%';
        return Math.round(v).toLocaleString();
    }

    function updateCharts() {
        const region = document.getElementById('region-select').value;
        renderChart('salesChart', '売上推移', [
            { label: '実績', data: getMonthlyValues(region, '売上', '実績'), type: 'bar', backgroundColor: '#3182ce' },
            { label: '予算', data: getMonthlyValues(region, '売上', '予算'), type: 'line', borderColor: '#e53e3e', tension: 0.1 }
        ]);
        renderChart('engChart', 'エンジニア内訳', [
            { label: 'プロパー(稼働)', data: getMonthlyValues(region, 'プロパー(稼働)', '実績'), type: 'bar', backgroundColor: '#4299e1' },
            { label: 'BP', data: getMonthlyValues(region, 'BP', '実績'), type: 'bar', backgroundColor: '#ed64a6' },
            { label: 'プロパー(待機)', data: getMonthlyValues(region, 'プロパー(待機)', '実績'), type: 'bar', backgroundColor: '#a0aec0' }
        ], 'stacked');
        renderChart('waitCostChart', '待機原価推移', [
            { label: '待機原価実績', data: getMonthlyValues(region, '待機原価', '実績'), type: 'line', fill: true, backgroundColor: 'rgba(237, 137, 54, 0.2)', borderColor: '#ed8936', tension: 0.3 }
        ]);
    }

    function renderChart(id, title, datasets, mode = 'default') {
        const ctx = document.getElementById(id).getContext('2d');
        if (charts[id]) charts[id].destroy();
        charts[id] = new Chart(ctx, {
            type: 'bar',
            data: { labels: ['6月','7月','8月','9月','10月','11月','12月','1月','2月','3月','4月','5月'], datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { title: { display: true, text: title, font: { size: 16 } } },
                scales: { x: { stacked: mode === 'stacked' }, y: { stacked: mode === 'stacked', beginAtZero: true } }
            }
        });
    }
</script>
</body>
</html>



